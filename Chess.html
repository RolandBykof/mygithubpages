<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accessible Chess</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
            padding: 1rem;
            color: #333;
            background-color: #f9f9f9;
        }
        input:focus, button:focus, select:focus, [tabindex="-1"]:focus {
            outline: 3px solid #005fcc; outline-offset: 2px;
        }
        h1, h2 { margin-bottom: 1rem; color: #202020; }
        #setup-area, #game-area, #moves-container, #help-container {
            background-color: #ffffff; border-radius: 10px; padding: 1.5rem; margin: 1rem 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        /* Chess Board Grid (Mobile Only) */
        #mobile-board {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            width: 100%;
            max-width: 400px;
            margin: 1rem auto;
            border: 2px solid #333;
            aspect-ratio: 1 / 1;
        }
        .square {
            aspect-ratio: 1 / 1;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            -webkit-tap-highlight-color: transparent;
        }
        .light { background-color: #eee; }
        .dark { background-color: #b58863; }
        .selected { outline: 4px solid #ff0 !important; outline-offset: -4px; }

        .button-list { list-style: none; padding: 0; margin-top: 1rem; }
        .button-list li { margin-bottom: 0.75rem; }

        .status-box {
            background-color: #e8f4f8; border: 1px solid #b8d8e8; border-radius: 8px;
            padding: 1rem; margin-bottom: 1rem; font-weight: 600; min-height: 3rem;
        }

        button {
            background-color: #005fcc; color: #ffffff; padding: 0.8rem 1.2rem;
            border: none; border-radius: 6px; cursor: pointer; font-size: 1rem;
            font-weight: 600; min-width: 200px; text-align: left;
        }

        .btn-secondary { background-color: #6c757d; }
        .hidden { display: none; }

        /* Responsive Logic */
        @media (min-width: 601px) {
            #mobile-board { display: none; }
            #desktop-input { display: block; }
        }
        @media (max-width: 600px) {
            #mobile-board { display: grid; }
            #desktop-input { display: none; }
            button { width: 100%; }
        }

        @media (prefers-color-scheme: dark) {
            body { background-color: #121212; color: #e0e0e0; }
            #setup-area, #game-area, #moves-container, #help-container { background-color: #1e1e1e; }
            .status-box { background-color: #1a2c35; border-color: #2a4658; }
            .light { background-color: #444; }
            .dark { background-color: #222; }
        }
    </style>
</head>
<body>

    <h1>Chess</h1>

    <div id="setup-area">
        <h2>Game Settings</h2>
        <label for="skillSelect">Engine Strength:</label>
        <select id="skillSelect">
            <option value="0">Casual</option>
            <option value="10">Intermediate</option>
            <option value="20" selected>Grandmaster</option>
        </select>
        <ul class="button-list">
            <li><button id="defaultAction" onclick="startGame('w')">Play as White</button></li>
            <li><button onclick="startGame('b')">Play as Black</button></li>
            <li><button id="helpBtn" onclick="toggleHelp('helpBtn')" class="btn-secondary">Help</button></li>
        </ul>
    </div>

    <div id="help-container" class="hidden">
        <h2 id="help-title" tabindex="-1">How to Play</h2>
        <p id="help-text-content"></p>
        <button onclick="toggleHelp()" class="btn-secondary" style="margin-top:1rem">Close Help</button>
    </div>

    <div id="game-area" class="hidden">
        <div id="status" class="status-box" role="alert" aria-live="assertive">Ready.</div>

        <div id="mobile-board" role="grid" aria-label="Chess Board"></div>

        <div id="desktop-input">
            <label for="moveInput">Enter move (e.g. e4):</label>
            <input id="moveInput" type="text" autocomplete="off" placeholder="e.g. e4">
            <button onclick="handleUserMove()">Move</button>
        </div>

        <ul class="button-list">
            <li><button onclick="announcePosition()" class="btn-secondary">Scan Board</button></li>
            <li><button id="toggleMovesBtn" onclick="toggleMoves()" class="btn-secondary" aria-expanded="false">Show Moves</button></li>
            <li><button onclick="location.reload()" class="btn-secondary">New Game</button></li>
        </ul>

        <div id="moves-container" class="hidden">
            <h2>Move List</h2>
            <ul id="moves-list"></ul>
        </div>
    </div>

    <script>
        const game = new Chess();
        let engine;
        let lastMoveText = "";
        let selectedSquare = null;
        const pieceUnicode = {
            'wk': '♔', 'wq': '♕', 'wr': '♖', 'wb': '♗', 'wn': '♘', 'wp': '♙',
            'bk': '♚', 'bq': '♛', 'br': '♜', 'bb': '♝', 'bn': '♞', 'bp': '♟'
        };

        window.onload = () => {
            document.getElementById('defaultAction').focus();
            renderBoard();
            setHelpText();
        };

        // Shortcuts
        window.addEventListener('keydown', (e) => {
            if (e.altKey && e.key.toLowerCase() === 'r') updateStatus(lastMoveText);
            if (e.altKey && e.key.toLowerCase() === 'p') announcePosition();
        });

        try {
            const blob = new Blob(["importScripts('https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.js');"], {type: 'application/javascript'});
            engine = new Worker(URL.createObjectURL(blob));
        } catch (e) {}

        function renderBoard() {
            const boardDiv = document.getElementById('mobile-board');
            boardDiv.innerHTML = '';
            const board = game.board();
            const isBlack = game.turn() === 'b';

            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    const squareName = String.fromCharCode(97 + c) + (8 - r);
                    const piece = board[r][c];
                    const btn = document.createElement('button');
                    btn.className = `square ${(r + c) % 2 === 0 ? 'light' : 'dark'}`;
                    if (selectedSquare === squareName) btn.classList.add('selected');
                    
                    btn.setAttribute('aria-label', `${squareName}: ${piece ? (piece.color === 'w' ? 'white' : 'black') + ' ' + piece.type : 'empty'}`);
                    btn.innerHTML = piece ? pieceUnicode[piece.color + piece.type] : '';
                    btn.onclick = () => handleSquareClick(squareName);
                    boardDiv.appendChild(btn);
                }
            }
        }

        function handleSquareClick(square) {
            if (!selectedSquare) {
                const piece = game.get(square);
                if (piece && piece.color === game.turn()) {
                    selectedSquare = square;
                    updateStatus("Selected " + square + ". Select destination.");
                    renderBoard();
                } else {
                    updateStatus("Select your own piece first.");
                }
            } else {
                const move = game.move({ from: selectedSquare, to: square, promotion: 'q' });
                selectedSquare = null;
                if (move) {
                    finalizeMove(move);
                    setTimeout(makeEngineMove, 600);
                } else {
                    updateStatus("Illegal move. Selection cleared.");
                }
                renderBoard();
            }
        }

        function handleUserMove() {
            const input = document.getElementById('moveInput');
            const move = game.move(input.value.trim());
            if (move) {
                input.value = '';
                finalizeMove(move);
                setTimeout(makeEngineMove, 600);
                renderBoard();
            } else {
                updateStatus("Illegal move.");
            }
        }

        function makeEngineMove() {
            if (game.game_over()) return;
            engine.onmessage = (e) => {
                if (e.data.includes('bestmove')) {
                    const move = game.move(e.data.split(' ')[1], { sloppy: true });
                    finalizeMove(move);
                    renderBoard();
                }
            };
            engine.postMessage('position fen ' + game.fen());
            engine.postMessage('go depth 12');
        }

        function finalizeMove(move) {
            const color = game.turn() === 'w' ? "black" : "white";
            lastMoveText = color + " " + move.san + (game.in_checkmate() ? " - checkmate" : "");
            updateStatus(lastMoveText);
            updateMovesDisplay();
        }

        function updateStatus(msg) {
            const s = document.getElementById('status');
            s.innerText = "";
            setTimeout(() => s.innerText = msg, 50);
        }

        function toggleHelp(tid) {
            const h = document.getElementById('help-container');
            h.classList.toggle('hidden');
            if (!h.classList.contains('hidden')) document.getElementById('help-title').focus();
        }

        function setHelpText() {
            const isMobile = window.innerWidth <= 600;
            document.getElementById('help-text-content').innerHTML = isMobile ? 
                "Tap a piece to select it, then tap the target square to move. Use Alt+R to repeat moves." :
                "Type moves in algebraic notation (e.g. e4) and press Move. Use Alt+R to repeat moves.";
        }

        function updateMovesDisplay() {
            const list = document.getElementById('moves-list');
            list.innerHTML = "";
            const history = game.history();
            for (let i = 0; i < history.length; i += 2) {
                const li = document.createElement('li');
                li.textContent = `${Math.floor(i/2)+1}. ${history[i]} ${history[i+1] || "..."}`;
                list.appendChild(li);
            }
        }

        function toggleMoves() {
            const c = document.getElementById('moves-container');
            c.classList.toggle('hidden');
        }

        function startGame(m) {
            document.getElementById('setup-area').classList.add('hidden');
            document.getElementById('game-area').classList.remove('hidden');
            if (m === 'b') setTimeout(makeEngineMove, 1000);
            else if (window.innerWidth > 600) document.getElementById('moveInput').focus();
        }

        function announcePosition() {
            const board = game.board();
            let p = [];
            for (let r=0; r<8; r++) {
                for (let c=0; c<8; c++) {
                    const pc = board[r][c];
                    if (pc) p.push(`${pc.color==='w'?'White':'Black'} ${pc.type} ${String.fromCharCode(97+c)}${8-r}`);
                }
            }
            updateStatus("Board: " + p.join(", "));
        }
    </script>
</body>
</html>