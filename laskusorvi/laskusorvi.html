<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laskusorvi</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsbarcode/3.11.5/JsBarcode.all.min.js"></script>
    <style>
/* Perustyylit */
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

:root {
    --primary-color: #2c3e50;
    --primary-dark: #1a252f;
    --secondary-color: #3498db;
    --accent-color: #e74c3c;
    --accent-hover: #c0392b;
    --background-color: #f8f9fa;
    --container-bg: #ffffff;
    --text-color: #2c3e50;
    --light-text: #7f8c8d;
    --border-color: #dee2e6;
    --table-header-bg: #f8f9fa;
    --table-border: #dee2e6;
    --success-color: #27ae60;
    --success-bg: #d5f4e6;
    --error-color: #e74c3c;
    --error-bg: #fdeaea;
    --border-radius: 8px;
    --shadow: 0 2px 10px rgba(0,0,0,0.1);
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    line-height: 1.6;
    max-width: 1200px;
    margin: 0 auto;
    padding: 1rem;
    color: var(--text-color);
    background-color: var(--background-color);
}

/* Typografia */
h1 {
    font-size: 2rem;
    margin-bottom: 1.5rem;
    color: var(--primary-color);
    text-align: center;
    font-weight: 300;
}

h2 {
    font-size: 1.3rem;
    margin-bottom: 1rem;
    margin-top: 2rem;
    color: var(--primary-color);
    border-bottom: 2px solid var(--secondary-color);
    padding-bottom: 0.5rem;
}

h3 {
    font-size: 1.1rem;
    margin-bottom: 0.8rem;
    color: var(--primary-color);
}

/* Kontainerit */
.container {
    background-color: var(--container-bg);
    padding: 2rem;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    margin-bottom: 2rem;
}

.form-container {
    max-width: 900px;
    margin: 0 auto;
}

/* Lomakkeet */
.form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-bottom: 1.5rem;
}

.form-group {
    margin-bottom: 1rem;
}

label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: var(--primary-color);
    font-size: 0.9rem;
}

input, textarea, select {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid var(--border-color);
    border-radius: var(--border-radius);
    font-size: 1rem;
    font-family: inherit;
    transition: border-color 0.3s ease;
}

input:focus, textarea:focus, select:focus {
    outline: none;
    border-color: var(--secondary-color);
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
}

/* Painikkeet */
button {
    background-color: var(--secondary-color);
    color: white;
    padding: 0.8rem 1.5rem;
    border: none;
    border-radius: var(--border-radius);
    cursor: pointer;
    font-size: 1rem;
    font-weight: 600;
    transition: all 0.3s ease;
    min-height: 44px;
}

button:hover:not([disabled]) {
    background-color: #2980b9;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

button:active {
    transform: translateY(0);
}

.button-primary {
    background-color: var(--primary-color);
}

.button-primary:hover {
    background-color: var(--primary-dark);
}

.button-accent {
    background-color: var(--accent-color);
}

.button-accent:hover {
    background-color: var(--accent-hover);
}

.button-success {
    background-color: var(--success-color);
}

.button-success:hover {
    background-color: #229954;
}

.button-container {
    display: flex;
    justify-content: center;
    gap: 1rem;
    margin-top: 2rem;
    flex-wrap: wrap;
}

/* Ilmoitukset */
.notification {
    padding: 1rem 1.5rem;
    margin: 1rem 0;
    border-radius: var(--border-radius);
    font-weight: 500;
    box-shadow: var(--shadow);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.notification.success {
    background-color: var(--success-bg);
    border-left: 4px solid var(--success-color);
    color: var(--success-color);
}

.notification.error {
    background-color: var(--error-bg);
    border-left: 4px solid var(--error-color);
    color: var(--error-color);
}

.notification.hidden {
    display: none;
}

/* Tietolaatikot */
.info-box {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: 1.5rem;
    margin: 1.5rem 0;
    box-shadow: var(--shadow);
}

.info-box p {
    margin: 0;
    color: var(--light-text);
}

.info-box.important {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    border-color: #f39c12;
}

.info-box.important p {
    color: #856404;
    font-weight: 600;
}

/* Tuotteet */
.product-item {
    background-color: #fafbfc;
    border: 2px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: 1.5rem;
    margin-bottom: 1rem;
    transition: all 0.3s ease;
}

.product-item:hover {
    border-color: var(--secondary-color);
    box-shadow: var(--shadow);
}

#products-container {
    margin-bottom: 1.5rem;
}

/* Valintaruudut */
.checkbox-container {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin: 1rem 0;
    padding: 1rem;
    background-color: var(--table-header-bg);
    border-radius: var(--border-radius);
    border: 1px solid var(--border-color);
}

.checkbox-container input[type="checkbox"] {
    width: 20px;
    height: 20px;
    margin: 0;
}

/* Responsiivinen design */
@media (max-width: 768px) {
    body {
        padding: 0.5rem;
    }
    
    .container {
        padding: 1rem;
    }
    
    h1 {
        font-size: 1.5rem;
    }
    
    .form-row {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .button-container {
        flex-direction: column;
    }
    
    button {
        width: 100%;
        margin: 0.25rem 0;
    }
}

/* Animaatiot */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.container {
    animation: fadeIn 0.5s ease-out;
}

/* Tulostusasetukset */
@media print {
    body {
        background-color: white;
        color: black;
    }
    
    .container {
        box-shadow: none;
        padding: 0;
    }
    
    button, .form-container {
        display: none;
    }
}

/* Dark mode */
@media (prefers-color-scheme: dark) {
    :root {
        --primary-color: #3498db;
        --secondary-color: #2ecc71;
        --background-color: #1a1a1a;
        --container-bg: #2d2d2d;
        --text-color: #ecf0f1;
        --light-text: #bdc3c7;
        --border-color: #4a4a4a;
        --table-header-bg: #3a3a3a;
    }
    
    input, textarea, select {
        background-color: #3a3a3a;
        color: var(--text-color);
        border-color: var(--border-color);
    }
    
    .product-item {
        background-color: #3a3a3a;
    }
}
    </style>
</head>
<body>
    <div class="container">
        <h1>Laskusorvi</h1>
        
        <div id="notification" class="notification hidden" role="alert" aria-live="assertive"></div>

        <div class="form-container">
            <form id="invoice-form">
                
                <h2>Laskun perustiedot</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="invoiceNumber">Laskun numero (3-19 numeroa)</label>
                        <input type="text" id="invoiceNumber" name="invoiceNumber" autocomplete="off">
                        <small style="color: var(--light-text); font-size: 0.85em;">Viitenumero luodaan automaattisesti</small>
                    </div>
                    <div class="form-group">
                        <label for="invoiceDate">Laskun päivämäärä</label>
                        <input type="date" id="invoiceDate" name="invoiceDate">
                    </div>
                    <div class="form-group">
                        <label for="dueDate">Eräpäivä</label>
                        <input type="date" id="dueDate" name="dueDate">
                    </div>
                </div>

                <h2>Laskuttajan tiedot</h2>
                <div class="info-box">
                    <p>Laskuttajan tiedot tallennetaan automaattisesti selaimen muistiin ja täytetään lomakkeeseen, kun avaat sovelluksen seuraavan kerran.</p>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="senderName">Yrityksen nimi</label>
                        <input type="text" id="senderName" name="senderName" autocomplete="organization">
                    </div>
                    <div class="form-group">
                        <label for="senderYTunnus">Y-tunnus</label>
                        <input type="text" id="senderYTunnus" name="senderYTunnus">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="senderAddress">Katuosoite</label>
                        <input type="text" id="senderAddress" name="senderAddress" autocomplete="address-line1">
                    </div>
                    <div class="form-group">
                        <label for="senderPostalCode">Postinumero</label>
                        <input type="text" id="senderPostalCode" name="senderPostalCode" autocomplete="postal-code">
                    </div>
                    <div class="form-group">
                        <label for="senderCity">Kaupunki</label>
                        <input type="text" id="senderCity" name="senderCity" autocomplete="address-level2">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="senderPhone">Puhelinnumero</label>
                        <input type="tel" id="senderPhone" name="senderPhone" autocomplete="tel">
                    </div>
                    <div class="form-group">
                        <label for="senderEmail">Sähköposti</label>
                        <input type="email" id="senderEmail" name="senderEmail" autocomplete="email">
                    </div>
                </div>

                <h2>Asiakkaan tiedot</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="recipientName">Asiakkaan nimi</label>
                        <input type="text" id="recipientName" name="recipientName">
                    </div>
                    <div class="form-group">
                        <label for="recipientYTunnus">Y-tunnus (jos yritysasiakas)</label>
                        <input type="text" id="recipientYTunnus" name="recipientYTunnus">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="recipientAddress">Katuosoite</label>
                        <input type="text" id="recipientAddress" name="recipientAddress">
                    </div>
                    <div class="form-group">
                        <label for="recipientPostalCode">Postinumero</label>
                        <input type="text" id="recipientPostalCode" name="recipientPostalCode">
                    </div>
                    <div class="form-group">
                        <label for="recipientCity">Kaupunki</label>
                        <input type="text" id="recipientCity" name="recipientCity">
                    </div>
                </div>

                <h2>Maksutiedot</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="accountNumber">Tilinumero</label>
                        <input type="text" id="accountNumber" name="accountNumber">
                    </div>
                    <div class="form-group">
                        <label for="paymentReference">Viite</label>
                        <input type="text" id="paymentReference" name="paymentReference" readonly style="background-color: #f8f9fa; cursor: not-allowed;">
                        <small style="color: var(--light-text); font-size: 0.85em;">Lasketaan automaattisesti laskun numeron perusteella</small>
                    </div>
                </div>

                <div class="checkbox-container">
                    <input type="checkbox" id="generateBarcode" name="generateBarcode" checked>
                    <label for="generateBarcode">Lisää viivakoodi</label>
                </div>

                <h2>Tuotteet ja palvelut</h2>
                <div id="products-container">
                    <!-- Tuotteet lisätään tähän dynaamisesti -->
                </div>
                
                <button type="button" id="add-product-btn" class="button-accent">Lisää uusi tuote/palvelu</button>

                <div class="form-row">
                    <div class="form-group">
                        <label for="taxRate">ALV-prosentti</label>
                        <select id="taxRate" name="taxRate">
                            <option value="0">0% (ALV-vapaa)</option>
                            <option value="10">10% (elintarvikkeet, kirjat)</option>
                            <option value="14">14% (ravintola, kulttuuripalvelut)</option>
                            <option value="25.5" selected>25.5% (yleinen ALV)</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="notes">Lisätiedot ja huomautukset</label>
                    <textarea id="notes" name="notes" rows="4"></textarea>
                </div>

                <div class="button-container">
                    <button type="button" id="create-pdf" class="button-success">Luo PDF-lasku</button>
                    <button type="button" id="save-sender-data" class="button-primary">Tallenna laskuttajan tiedot</button>
                    <button type="button" id="clear-sender-data" class="button-accent">Tyhjennä tallennetut tiedot</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let productCounter = 0;
        
        const senderFieldIds = [
            'senderName', 'senderYTunnus', 'senderAddress', 'senderPostalCode', 
            'senderCity', 'senderPhone', 'senderEmail', 'accountNumber', 'taxRate'
        ];
        
        // Suomalaisen viitenumeron laskenta
        function calculateFinnishReference(base) {
            const cleanBase = base.replace(/\D/g, '');
            if (cleanBase.length < 3 || cleanBase.length > 19) return '';
            
            const multipliers = [7, 3, 1];
            let sum = 0;
            
            for (let i = 0; i < cleanBase.length; i++) {
                const digit = parseInt(cleanBase[cleanBase.length - 1 - i]);
                const multiplier = multipliers[i % 3];
                sum += digit * multiplier;
            }
            
            const nextTen = Math.ceil(sum / 10) * 10;
            let checkDigit = nextTen - sum;
            if (checkDigit === 10) checkDigit = 0;
            
            return cleanBase + checkDigit;
        }
        
        function updateReference() {
            const invoiceNumber = document.getElementById('invoiceNumber').value;
            const referenceField = document.getElementById('paymentReference');
            
            if (invoiceNumber.trim()) {
                const reference = calculateFinnishReference(invoiceNumber);
                if (reference) {
                    // Formatoidaan viitenumero ryhmiin luettavuuden parantamiseksi (vain näytössä)
                    const formatted = reference.replace(/(?=(?:\d{5})+(?!\d))(?=\d)/g, ' ');
                    referenceField.value = formatted;
                } else {
                    referenceField.value = '';
                }
            } else {
                referenceField.value = '';
            }
        }
        
        // Virtuaaliviivakoodin luonti
        function createVirtualBarcode(data) {
            try {
                const version = '4';
                
                let iban = (data.payment.accountNumber || '').replace(/\s+/g, '');
                if (iban.toUpperCase().startsWith('FI')) {
                    iban = iban.slice(2);
                }
                iban = iban.padStart(16, '0').substring(0, 16);
                
                const amountCents = Math.round(data.total * 100);
                const euros = Math.floor(amountCents / 100);
                const cents = amountCents % 100;
                const eurosStr = euros.toString().padStart(6, '0');
                const centsStr = cents.toString().padStart(2, '0');
                
                const reserved = '000';
                
                let reference = (data.payment.reference || '').replace(/\s+/g, '');
                reference = reference.padStart(20, '0').substring(0, 20);
                
                let dueDateStr = '000000';
                const dueDate = new Date(data.dueDate);
                if (!isNaN(dueDate.getTime())) {
                    const yy = dueDate.getFullYear().toString().slice(-2);
                    const mm = (dueDate.getMonth() + 1).toString().padStart(2, '0');
                    const dd = dueDate.getDate().toString().padStart(2, '0');
                    dueDateStr = yy + mm + dd;
                }
                
                const barcode = version + iban + eurosStr + centsStr + reserved + reference + dueDateStr;
                
                if (barcode.length !== 54) {
                    throw new Error(`Viivakoodin pituus ${barcode.length}, odotettu 54`);
                }
                
                return barcode;
            } catch (err) {
                console.error('Virhe viivakoodin luonnissa:', err);
                return '';
            }
        }
        
        // Viivakoodin generointi Canvas-elementissä
        function generateBarcode(text) {
            try {
                if (!text || text.trim() === '') {
                    throw new Error('Viivakoodin sisältö on tyhjä');
                }
                
                console.log('Generoidaan viivakoodi tekstille:', text);
                
                // Luo canvas-elementti
                const canvas = document.createElement('canvas');
                canvas.width = 600;
                canvas.height = 100;
                
                // Generoi viivakoodi käyttäen JsBarcode-kirjastoa
                JsBarcode(canvas, text, {
                    format: "CODE128",
                    width: 2,
                    height: 80,
                    displayValue: false,
                    background: "#ffffff",
                    lineColor: "#000000",
                    margin: 10
                });
                
                // Muunna canvas data URL:ksi
                const dataUrl = canvas.toDataURL('image/png');
                console.log('Viivakoodi luotu onnistuneesti');
                return dataUrl;
                
            } catch (err) {
                console.error('Viivakoodin generointi epäonnistui:', err.message);
                return null;
            }
        }
        
        // Lomakkeen alustus
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Alustetaan ammattimainen laskusorvi (viivakoodilla)");
            
            const today = new Date();
            document.getElementById('invoiceDate').valueAsDate = today;
            
            const dueDate = new Date(today);
            dueDate.setDate(today.getDate() + 14);
            document.getElementById('dueDate').valueAsDate = dueDate;
            
            loadSenderData();
            addProductRow();
            document.getElementById('invoiceNumber').focus();
            
            // Event listenerit
            document.getElementById('add-product-btn').addEventListener('click', addProductRow);
            document.getElementById('create-pdf').addEventListener('click', createPDF);
            document.getElementById('invoiceNumber').addEventListener('input', updateReference);
            
            document.getElementById('save-sender-data').addEventListener('click', function() {
                saveSenderData();
                showNotification('Laskuttajan tiedot tallennettu onnistuneesti!', 'success');
            });
            
            document.getElementById('clear-sender-data').addEventListener('click', clearSenderData);
        });
        
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.remove('hidden');
            
            setTimeout(function() {
                notification.classList.add('hidden');
            }, 4000);
        }
        
        function saveSenderData() {
            console.log("Tallennetaan laskuttajan tiedot localStorage:een");
            
            try {
                // Tarkistetaan onko localStorage käytettävissä
                if (typeof(Storage) === "undefined") {
                    console.warn("localStorage ei ole käytettävissä tässä selaimessa");
                    showNotification('Tietojen tallennus ei ole mahdollista tässä selaimessa', 'error');
                    return;
                }
                
                let savedCount = 0;
                
                // Tallennetaan jokainen laskuttajan kenttä erikseen
                senderFieldIds.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field && field.value.trim() !== '') {
                        localStorage.setItem(`laskusorvi_${fieldId}`, field.value.trim());
                        savedCount++;
                    }
                });
                
                console.log(`Tallennettu ${savedCount} kenttää localStorage:een`);
                
                if (savedCount > 0) {
                    // Tallennetaan myös tallennusaika
                    localStorage.setItem('laskusorvi_lastSaved', new Date().toISOString());
                }
                
            } catch (error) {
                console.error("Virhe tallentaessa localStorage:een:", error);
                showNotification('Tietojen tallentaminen epäonnistui', 'error');
            }
        }

        function loadSenderData() {
            console.log("Ladataan laskuttajan tiedot localStorage:sta");
            
            try {
                // Tarkistetaan onko localStorage käytettävissä
                if (typeof(Storage) === "undefined") {
                    console.log("localStorage ei ole käytettävissä");
                    return;
                }
                
                let dataFound = false;
                let loadedCount = 0;
                
                // Ladataan jokainen laskuttajan kenttä erikseen
                senderFieldIds.forEach(fieldId => {
                    const savedValue = localStorage.getItem(`laskusorvi_${fieldId}`);
                    const field = document.getElementById(fieldId);
                    
                    if (savedValue && field) {
                        field.value = savedValue;
                        dataFound = true;
                        loadedCount++;
                    }
                });
                
                if (dataFound) {
                    console.log(`Ladattu ${loadedCount} kenttää localStorage:sta`);
                    
                    // Tarkistetaan tallennusaika
                    const lastSaved = localStorage.getItem('laskusorvi_lastSaved');
                    if (lastSaved) {
                        const savedDate = new Date(lastSaved);
                        const timeAgo = Math.round((new Date() - savedDate) / (1000 * 60 * 60 * 24));
                        
                        if (timeAgo === 0) {
                            showNotification('Tallennetut laskuttajan tiedot ladattu! (tallennettu tänään)', 'success');
                        } else if (timeAgo === 1) {
                            showNotification('Tallennetut laskuttajan tiedot ladattu! (tallennettu eilen)', 'success');
                        } else if (timeAgo < 30) {
                            showNotification(`Tallennetut laskuttajan tiedot ladattu! (tallennettu ${timeAgo} päivää sitten)`, 'success');
                        } else {
                            showNotification('Tallennetut laskuttajan tiedot ladattu!', 'success');
                        }
                    } else {
                        showNotification('Tallennetut laskuttajan tiedot ladattu!', 'success');
                    }
                } else {
                    console.log("Tallennettuja laskuttajan tietoja ei löytynyt");
                }
                
            } catch (error) {
                console.error("Virhe ladatessa localStorage:sta:", error);
                showNotification('Tietojen lataaminen epäonnistui', 'error');
            }
        }

        function clearSenderData() {
            console.log("Tyhjennetään tallennetut laskuttajan tiedot");
            
            try {
                // Tarkistetaan onko localStorage käytettävissä
                if (typeof(Storage) === "undefined") {
                    console.warn("localStorage ei ole käytettävissä");
                    // Tyhjennetään vain lomake
                    clearFormFields();
                    return;
                }
                
                let removedCount = 0;
                
                // Tyhjennetään jokainen laskuttajan kenttä localStorage:sta
                senderFieldIds.forEach(fieldId => {
                    const key = `laskusorvi_${fieldId}`;
                    if (localStorage.getItem(key) !== null) {
                        localStorage.removeItem(key);
                        removedCount++;
                    }
                });
                
                // Poistetaan myös tallennusaika
                localStorage.removeItem('laskusorvi_lastSaved');
                
                // Tyhjennetään lomakkeen kentät
                clearFormFields();
                
                console.log(`Poistettu ${removedCount} kenttää localStorage:sta`);
                showNotification('Tallennetut laskuttajan tiedot on tyhjennetty.', 'error');
                
            } catch (error) {
                console.error("Virhe tyhjentäessä localStorage:ta:", error);
                // Tyhjennetään ainakin lomake
                clearFormFields();
                showNotification('Lomake tyhjennetty (osittainen virhe tallennuksen tyhjentämisessä)', 'error');
            }
        }

        /**
         * Apufunktio lomakkeen kenttien tyhjentämiseen
         */
        function clearFormFields() {
            senderFieldIds.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.value = '';
                }
            });
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('fi-FI');
        }
        
        function formatNumber(number) {
            return Number(number).toFixed(2).replace('.', ',');
        }
        
        function addProductRow() {
            const productsContainer = document.getElementById('products-container');
            
            const productItem = document.createElement('div');
            productItem.className = 'product-item';
            productItem.id = `product-${productCounter}`;
            
            productItem.innerHTML = `
                <div class="form-row">
                    <div class="form-group">
                        <label for="productDescription${productCounter}">Tuotteen/palvelun kuvaus</label>
                        <input type="text" id="productDescription${productCounter}" name="productDescription${productCounter}">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="productQuantity${productCounter}">Määrä</label>
                        <input type="number" id="productQuantity${productCounter}" name="productQuantity${productCounter}" value="1" min="1" step="1">
                    </div>
                    <div class="form-group">
                        <label for="productUnit${productCounter}">Yksikkö</label>
                        <input type="text" id="productUnit${productCounter}" name="productUnit${productCounter}" value="kpl">
                    </div>
                    <div class="form-group">
                        <label for="productPrice${productCounter}">Yksikköhinta (€, ALV 0%)</label>
                        <input type="number" id="productPrice${productCounter}" name="productPrice${productCounter}" min="0" step="0.01">
                    </div>
                </div>
            `;
            
            if (productCounter > 0) {
                const removeButton = document.createElement('button');
                removeButton.type = 'button';
                removeButton.className = 'button-accent';
                removeButton.style.marginTop = '1rem';
                removeButton.textContent = 'Poista tämä tuote';
                removeButton.dataset.id = `product-${productCounter}`;
                
                removeButton.addEventListener('click', function() {
                    const productId = this.dataset.id;
                    const productToRemove = document.getElementById(productId);
                    if (productToRemove) {
                        productsContainer.removeChild(productToRemove);
                        showNotification('Tuote poistettu', 'error');
                    }
                });
                
                productItem.appendChild(removeButton);
            }
            
            productsContainer.appendChild(productItem);
            document.getElementById(`productDescription${productCounter}`).focus();
            productCounter++;
        }
        
        function collectFormData() {
            const formData = {
                invoiceNumber: document.getElementById('invoiceNumber').value,
                invoiceDate: document.getElementById('invoiceDate').value,
                dueDate: document.getElementById('dueDate').value,
                sender: {
                    name: document.getElementById('senderName').value,
                    ytunnus: document.getElementById('senderYTunnus').value,
                    address: document.getElementById('senderAddress').value,
                    postalCode: document.getElementById('senderPostalCode').value,
                    city: document.getElementById('senderCity').value,
                    phone: document.getElementById('senderPhone').value,
                    email: document.getElementById('senderEmail').value
                },
                recipient: {
                    name: document.getElementById('recipientName').value,
                    ytunnus: document.getElementById('recipientYTunnus').value,
                    address: document.getElementById('recipientAddress').value,
                    postalCode: document.getElementById('recipientPostalCode').value,
                    city: document.getElementById('recipientCity').value
                },
                payment: {
                    accountNumber: document.getElementById('accountNumber').value,
                    reference: document.getElementById('paymentReference').value.replace(/\s+/g, '')
                },
                products: [],
                taxRate: parseFloat(document.getElementById('taxRate').value),
                notes: document.getElementById('notes').value,
                generateBarcode: document.getElementById('generateBarcode').checked
            };
            
            // Kerää tuotteet
            const productItems = document.querySelectorAll('.product-item');
            productItems.forEach((item) => {
                const idNum = item.id.split('-')[1];
                const description = document.getElementById(`productDescription${idNum}`)?.value || '';
                const quantity = parseFloat(document.getElementById(`productQuantity${idNum}`)?.value || '1');
                const unit = document.getElementById(`productUnit${idNum}`)?.value || 'kpl';
                const price = parseFloat(document.getElementById(`productPrice${idNum}`)?.value || '0');
                
                if (description.trim()) {
                    const total = quantity * price;
                    formData.products.push({ description, quantity, unit, price, total });
                }
            });
            
            // Laske summat
            let subtotal = 0;
            formData.products.forEach(product => {
                subtotal += product.total;
            });
            
            const taxAmount = subtotal * (formData.taxRate / 100);
            const total = subtotal + taxAmount;
            
            formData.subtotal = subtotal;
            formData.taxAmount = taxAmount;
            formData.total = total;
            
            return formData;
        }
        
        // PDF-luonti viivakoodilla, möttönen-tyylisellä layoutilla
        function createPDF() {
            saveSenderData();
            const data = collectFormData();
            
            console.log('Luodaan PDF seuraavilla tiedoilla:', data);
            
            // Validointi
            if (!data.invoiceNumber) {
                showNotification('Laskun numero puuttuu!', 'error');
                return;
            }
            if (!data.sender.name) {
                showNotification('Laskuttajan nimi puuttuu!', 'error');
                return;
            }
            if (!data.recipient.name) {
                showNotification('Asiakkaan nimi puuttuu!', 'error');
                return;
            }
            if (data.products.length === 0) {
                showNotification('Lisää vähintään yksi tuote!', 'error');
                return;
            }
            if (!data.payment.accountNumber) {
                showNotification('IBAN-tilinumero puuttuu!', 'error');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4',
                putOnlyUsedFonts: true
            });
            
            // PDF metatiedot
            doc.setProperties({
                title: data.invoiceNumber ? `Lasku ${data.invoiceNumber}` : 'Lasku',
                subject: `Lasku ${data.sender.name || ''} - ${data.recipient.name || ''}`,
                creator: 'PDF-laskugeneraattori',
                author: data.sender.name || 'Laskuttaja',
                keywords: 'lasku, invoice',
                lang: 'fi-FI'
            });
            
            // Möttönen-tyylinen layout
            createSimpleLayout(doc, data);
        }
        
        // Yksinkertainen layout möttönen-tyylin mukaan
        function createSimpleLayout(doc, data) {
            // Fonttikoot ja marginaalit
            const margin = 20; // mm
            const lineHeight = 7; // mm
            const fontSizeNormal = 10;
            const fontSizeLarge = 16;
            const fontSizeMedium = 12;
            
            // Asetetaan fontti ja kieli
            doc.setFont("helvetica", "normal");
            doc.setLanguage("fi");
            doc.setTextColor(0, 0, 0); // Musta teksti
            
            let y = margin;
            
            // --- Laskun otsikko ---
            doc.setFontSize(fontSizeLarge);
            doc.text('LASKU', margin, y);
            
            if (data.invoiceNumber) {
                doc.setFontSize(fontSizeNormal);
                y += lineHeight;
                doc.text(`Laskun numero: ${data.invoiceNumber}`, margin, y);
            }
            
            // --- Laskuttajan tiedot ---
            doc.setFontSize(fontSizeMedium);
            y += lineHeight * 2;
            doc.text('Laskuttaja', margin, y);
            
            doc.setFontSize(fontSizeNormal);
            
            if (data.sender.name) {
                y += lineHeight;
                doc.text(data.sender.name, margin, y);
            }
            
            if (data.sender.ytunnus) {
                y += lineHeight;
                doc.text(`Y-tunnus: ${data.sender.ytunnus}`, margin, y);
            }
            
            if (data.sender.address) {
                y += lineHeight;
                doc.text(data.sender.address, margin, y);
            }
            
            if (data.sender.postalCode || data.sender.city) {
                y += lineHeight;
                doc.text(`${data.sender.postalCode || ''} ${data.sender.city || ''}`, margin, y);
            }
            
            if (data.sender.phone) {
                y += lineHeight;
                doc.text(`Puhelin: ${data.sender.phone}`, margin, y);
            }
            
            if (data.sender.email) {
                y += lineHeight;
                doc.text(`Sähköposti: ${data.sender.email}`, margin, y);
            }
            
            // --- Päivämäärätiedot ---
            y += lineHeight * 2;
            
            if (data.invoiceDate) {
                doc.text(`Laskun päivämäärä: ${formatDate(data.invoiceDate)}`, margin, y);
                y += lineHeight;
            }
            
            if (data.dueDate) {
                doc.text(`Eräpäivä: ${formatDate(data.dueDate)}`, margin, y);
                y += lineHeight;
            }
            
            // --- Asiakkaan tiedot ---
            doc.setFontSize(fontSizeMedium);
            y += lineHeight * 2;
            doc.text('Laskutettava', margin, y);
            
            doc.setFontSize(fontSizeNormal);
            
            if (data.recipient.name) {
                y += lineHeight;
                doc.text(data.recipient.name, margin, y);
            }
            
            if (data.recipient.ytunnus) {
                y += lineHeight;
                doc.text(`Y-tunnus: ${data.recipient.ytunnus}`, margin, y);
            }
            
            if (data.recipient.address) {
                y += lineHeight;
                doc.text(data.recipient.address, margin, y);
            }
            
            if (data.recipient.postalCode || data.recipient.city) {
                y += lineHeight;
                doc.text(`${data.recipient.postalCode || ''} ${data.recipient.city || ''}`, margin, y);
            }
            
            // --- Tuotteet ---
            y += lineHeight * 2;
            doc.setFontSize(fontSizeMedium);
            doc.text('Tuotteet / Palvelut', margin, y);
            
            // Taulukon otsikkorivi
            y += lineHeight * 1.5;
            doc.setFontSize(fontSizeNormal);
            doc.setFont("helvetica", "bold");
            
            const colWidths = [80, 20, 20, 25, 25]; // mm
            const headers = ['Kuvaus', 'Määrä', 'Yksikkö', 'Hinta (€)', 'Yhteensä (€)'];
            
            let xPos = margin;
            headers.forEach((header, i) => {
                doc.text(header, xPos, y);
                xPos += colWidths[i];
            });
            
            doc.setFont("helvetica", "normal");
            
            // Tuoterivit
            if (data.products && data.products.length > 0) {
                data.products.forEach(product => {
                    y += lineHeight;
                    
                    // Jos sivu täyttyy, luodaan uusi sivu
                    if (y > 277) { // A4 korkeus (297mm) - alareuna (20mm)
                        doc.addPage();
                        y = margin;
                        
                        // Lisätään otsikkorivi uudelle sivulle
                        doc.setFont("helvetica", "bold");
                        xPos = margin;
                        headers.forEach((header, i) => {
                            doc.text(header, xPos, y);
                            xPos += colWidths[i];
                        });
                        doc.setFont("helvetica", "normal");
                        y += lineHeight;
                    }
                    
                    xPos = margin;
                    
                    // Kuvaus
                    doc.text(product.description || '', xPos, y);
                    xPos += colWidths[0];
                    
                    // Määrä
                    doc.text(String(product.quantity || ''), xPos, y);
                    xPos += colWidths[1];
                    
                    // Yksikkö
                    doc.text(product.unit || '', xPos, y);
                    xPos += colWidths[2];
                    
                    // Hinta
                    doc.text(formatNumber(product.price || 0), xPos, y);
                    xPos += colWidths[3];
                    
                    // Yhteensä
                    doc.text(formatNumber(product.total || 0), xPos, y);
                });
            }
            
            // --- Laskun summat ---
            y += lineHeight * 2;
            
            doc.text(`Veroton summa: ${formatNumber(data.subtotal)}`, margin, y);
            y += lineHeight;
            doc.text(`ALV (${data.taxRate}%): ${formatNumber(data.taxAmount)}`, margin, y);
            y += lineHeight;
            doc.setFont("helvetica", "bold");
            doc.text(`Yhteensä: ${formatNumber(data.total)}`, margin, y);
            doc.setFont("helvetica", "normal");
            
            // --- Maksutiedot ---
            y += lineHeight * 2;
            doc.setFontSize(fontSizeMedium);
            doc.text('Maksutiedot', margin, y);
            
            doc.setFontSize(fontSizeNormal);
            
            if (data.payment.accountNumber) {
                y += lineHeight;
                doc.text(`IBAN: ${data.payment.accountNumber}`, margin, y);
            }
            
            if (data.payment.reference) {
                y += lineHeight;
                doc.text(`Viitenumero: ${data.payment.reference}`, margin, y);
            }
            
            // --- VIIVAKOODI ---
            if (data.generateBarcode) {
                // Virtuaaliviivakoodi
                const barcode = createVirtualBarcode(data);
                if (barcode) {
                    y += lineHeight * 2;
                    doc.setFontSize(fontSizeMedium);
                    doc.text('Virtuaaliviivakoodi', margin, y);
                    
                    y += lineHeight;
                    doc.setFont("courier", "normal");
                    doc.setFontSize(10);
                    doc.text(barcode, margin, y);
                    
                    y += lineHeight * 2;
                    
                    // Generoi viivakoodi kuva
                    const barcodeDataUrl = generateBarcode(barcode);
                    if (barcodeDataUrl) {
                        console.log('Viivakoodi luotu onnistuneesti, lisätään PDF:ään...');
                        
                        try {
                            // Lisää viivakoodi PDF:ään
                            const barcodeWidth = 120;
                            const barcodeHeight = 20;
                            
                            doc.addImage(barcodeDataUrl, 'PNG', margin, y, barcodeWidth, barcodeHeight);
                            
                            console.log('Viivakoodi lisätty PDF:ään onnistuneesti');
                            
                            // Päivitä y-koordinaatti viivakoodin jälkeen
                            y += barcodeHeight + lineHeight;
                            
                        } catch (imageError) {
                            console.error('Virhe viivakoodin lisäämisessä PDF:ään:', imageError);
                            showNotification('Viivakoodin lisääminen epäonnistui, mutta PDF luotiin', 'error');
                            y += lineHeight;
                        }
                    } else {
                        console.error('Viivakoodin generointi epäonnistui');
                        showNotification('Viivakoodin luonti epäonnistui, mutta PDF luotiin', 'error');
                        y += lineHeight;
                    }
                }
            }
            
            // Lisätiedot
            if (data.notes && data.notes.trim()) {
                y += lineHeight * 2;
                
                // Tarkista ettei mene sivun ulkopuolelle
                if (y + 20 < 277) {
                    doc.setFontSize(fontSizeMedium);
                    doc.text('Lisätiedot:', margin, y);
                    
                    doc.setFontSize(fontSizeNormal);
                    y += lineHeight;
                    const splitNotes = doc.splitTextToSize(data.notes, 170); // 210mm - marginaalit
                    
                    // Lisätään rivit dokumenttiin
                    splitNotes.forEach(line => {
                        // Tarkistetaan, mahtuuko rivi vielä sivulle
                        if (y > 277) {
                            doc.addPage();
                            y = margin;
                        }
                        
                        doc.text(line, margin, y);
                        y += lineHeight;
                    });
                } else {
                    // Jos ei mahdu, lisää uusi sivu
                    doc.addPage();
                    const newPageY = margin + 10;
                    
                    doc.setFontSize(fontSizeMedium);
                    doc.text('Lisätiedot:', margin, newPageY);
                    
                    doc.setFontSize(fontSizeNormal);
                    const splitNotes = doc.splitTextToSize(data.notes, 170);
                    let currentY = newPageY + lineHeight;
                    splitNotes.forEach(line => {
                        doc.text(line, margin, currentY);
                        currentY += lineHeight;
                    });
                }
            }
            
            // Tallenna PDF
            const filename = `lasku_${data.invoiceNumber}.pdf`;
            
            try {
                doc.save(filename);
                console.log('PDF tallennettu onnistuneesti:', filename);
                showNotification(`PDF-lasku "${filename}" luotu onnistuneesti! ${data.generateBarcode ? 'Viivakoodi toimii pankkisovelluksissa.' : ''}`, 'success');
            } catch (saveError) {
                console.error('PDF:n tallentaminen epäonnistui:', saveError);
                showNotification('PDF:n tallentaminen epäonnistui!', 'error');
            }
        }
    </script>
</body>
</html>