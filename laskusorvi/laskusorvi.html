<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laskusorvi</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsbarcode/3.11.5/JsBarcode.all.min.js"></script>
    <style>
/* Perustyylit */
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

:root {
    --primary-color: #2c3e50;
    --primary-dark: #1a252f;
    --secondary-color: #3498db;
    --accent-color: #e74c3c;
    --accent-hover: #c0392b;
    --background-color: #f8f9fa;
    --container-bg: #ffffff;
    --text-color: #2c3e50;
    --light-text: #7f8c8d;
    --border-color: #dee2e6;
    --table-header-bg: #f8f9fa;
    --table-border: #dee2e6;
    --success-color: #27ae60;
    --success-bg: #d5f4e6;
    --error-color: #e74c3c;
    --error-bg: #fdeaea;
    --border-radius: 8px;
    --shadow: 0 2px 10px rgba(0,0,0,0.1);
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    line-height: 1.6;
    max-width: 1200px;
    margin: 0 auto;
    padding: 1rem;
    color: var(--text-color);
    background-color: var(--background-color);
}

/* Typografia */
h1 {
    font-size: 2rem;
    margin-bottom: 1.5rem;
    color: var(--primary-color);
    text-align: center;
    font-weight: 300;
}

h2 {
    font-size: 1.3rem;
    margin-bottom: 1rem;
    margin-top: 2rem;
    color: var(--primary-color);
    border-bottom: 2px solid var(--secondary-color);
    padding-bottom: 0.5rem;
}

h3 {
    font-size: 1.1rem;
    margin-bottom: 0.8rem;
    color: var(--primary-color);
}

/* Kontainerit */
.container {
    background-color: var(--container-bg);
    padding: 2rem;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    margin-bottom: 2rem;
}

.form-container {
    max-width: 900px;
    margin: 0 auto;
}

/* Lomakkeet */
.form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-bottom: 1.5rem;
}

.form-group {
    margin-bottom: 1rem;
}

label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: var(--primary-color);
    font-size: 0.9rem;
}

input, textarea, select {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid var(--border-color);
    border-radius: var(--border-radius);
    font-size: 1rem;
    font-family: inherit;
    transition: border-color 0.3s ease;
}

input:focus, textarea:focus, select:focus {
    outline: none;
    border-color: var(--secondary-color);
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
}

/* Painikkeet */
button {
    background-color: var(--secondary-color);
    color: white;
    padding: 0.8rem 1.5rem;
    border: none;
    border-radius: var(--border-radius);
    cursor: pointer;
    font-size: 1rem;
    font-weight: 600;
    transition: all 0.3s ease;
    min-height: 44px;
}

button:hover:not([disabled]) {
    background-color: #2980b9;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

button:active {
    transform: translateY(0);
}

.button-primary {
    background-color: var(--primary-color);
}

.button-primary:hover {
    background-color: var(--primary-dark);
}

.button-accent {
    background-color: var(--accent-color);
}

.button-accent:hover {
    background-color: var(--accent-hover);
}

.button-success {
    background-color: var(--success-color);
}

.button-success:hover {
    background-color: #229954;
}

.button-container {
    display: flex;
    justify-content: center;
    gap: 1rem;
    margin-top: 2rem;
    flex-wrap: wrap;
}

/* Ilmoitukset */
.notification {
    padding: 1rem 1.5rem;
    margin: 1rem 0;
    border-radius: var(--border-radius);
    font-weight: 500;
    box-shadow: var(--shadow);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.notification.success {
    background-color: var(--success-bg);
    border-left: 4px solid var(--success-color);
    color: var(--success-color);
}

.notification.error {
    background-color: var(--error-bg);
    border-left: 4px solid var(--error-color);
    color: var(--error-color);
}

.notification.hidden {
    display: none;
}

/* Tietolaatikot */
.info-box {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: 1.5rem;
    margin: 1.5rem 0;
    box-shadow: var(--shadow);
}

.info-box p {
    margin: 0;
    color: var(--light-text);
}

.info-box.important {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    border-color: #f39c12;
}

.info-box.important p {
    color: #856404;
    font-weight: 600;
}

/* Tuotteet */
.product-item {
    background-color: #fafbfc;
    border: 2px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: 1.5rem;
    margin-bottom: 1rem;
    transition: all 0.3s ease;
}

.product-item:hover {
    border-color: var(--secondary-color);
    box-shadow: var(--shadow);
}

#products-container {
    margin-bottom: 1.5rem;
}

/* Valintaruudut */
.checkbox-container {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin: 1rem 0;
    padding: 1rem;
    background-color: var(--table-header-bg);
    border-radius: var(--border-radius);
    border: 1px solid var(--border-color);
}

.checkbox-container input[type="checkbox"] {
    width: 20px;
    height: 20px;
    margin: 0;
}

/* Responsiivinen design */
@media (max-width: 768px) {
    body {
        padding: 0.5rem;
    }
    
    .container {
        padding: 1rem;
    }
    
    h1 {
        font-size: 1.5rem;
    }
    
    .form-row {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .button-container {
        flex-direction: column;
    }
    
    button {
        width: 100%;
        margin: 0.25rem 0;
    }
}

/* Animaatiot */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.container {
    animation: fadeIn 0.5s ease-out;
}

/* Tulostusasetukset */
@media print {
    body {
        background-color: white;
        color: black;
    }
    
    .container {
        box-shadow: none;
        padding: 0;
    }
    
    button, .form-container {
        display: none;
    }
}

/* Dark mode */
@media (prefers-color-scheme: dark) {
    :root {
        --primary-color: #3498db;
        --secondary-color: #2ecc71;
        --background-color: #1a1a1a;
        --container-bg: #2d2d2d;
        --text-color: #ecf0f1;
        --light-text: #bdc3c7;
        --border-color: #4a4a4a;
        --table-header-bg: #3a3a3a;
    }
    
    input, textarea, select {
        background-color: #3a3a3a;
        color: var(--text-color);
        border-color: var(--border-color);
    }
    
    .product-item {
        background-color: #3a3a3a;
    }
}
    </style>
</head>
<body>
    <div class="container">
        <h1>Laskusorvi</h1>
        
        <div id="notification" class="notification hidden" role="alert" aria-live="assertive"></div>

        <div class="form-container">
            <form id="invoice-form">
                
                <h2>Laskun perustiedot</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="invoiceNumber">Laskun numero (3-19 numeroa)</label>
                        <input type="text" id="invoiceNumber" name="invoiceNumber" autocomplete="off">
                        <small style="color: var(--light-text); font-size: 0.85em;">Viitenumero luodaan automaattisesti</small>
                    </div>
                    <div class="form-group">
                        <label for="invoiceDate">Laskun päivämäärä</label>
                        <input type="date" id="invoiceDate" name="invoiceDate">
                    </div>
                    <div class="form-group">
                        <label for="dueDate">Eräpäivä</label>
                        <input type="date" id="dueDate" name="dueDate">
                    </div>
                </div>

                <h2>Laskuttajan tiedot</h2>
                <div class="info-box">
                    <p>Laskuttajan tiedot tallennetaan automaattisesti selaimen muistiin ja täytetään lomakkeeseen, kun avaat sovelluksen seuraavan kerran.</p>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="senderName">Yrityksen nimi</label>
                        <input type="text" id="senderName" name="senderName" autocomplete="organization">
                    </div>
                    <div class="form-group">
                        <label for="senderYTunnus">Y-tunnus</label>
                        <input type="text" id="senderYTunnus" name="senderYTunnus">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="senderAddress">Katuosoite</label>
                        <input type="text" id="senderAddress" name="senderAddress" autocomplete="address-line1">
                    </div>
                    <div class="form-group">
                        <label for="senderPostalCode">Postinumero</label>
                        <input type="text" id="senderPostalCode" name="senderPostalCode" autocomplete="postal-code">
                    </div>
                    <div class="form-group">
                        <label for="senderCity">Kaupunki</label>
                        <input type="text" id="senderCity" name="senderCity" autocomplete="address-level2">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="senderPhone">Puhelinnumero</label>
                        <input type="tel" id="senderPhone" name="senderPhone" autocomplete="tel">
                    </div>
                    <div class="form-group">
                        <label for="senderEmail">Sähköposti</label>
                        <input type="email" id="senderEmail" name="senderEmail" autocomplete="email">
                    </div>
                </div>

                <h2>Asiakkaan tiedot</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="recipientName">Asiakkaan nimi</label>
                        <input type="text" id="recipientName" name="recipientName">
                    </div>
                    <div class="form-group">
                        <label for="recipientYTunnus">Y-tunnus (jos yritysasiakas)</label>
                        <input type="text" id="recipientYTunnus" name="recipientYTunnus">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="recipientAddress">Katuosoite</label>
                        <input type="text" id="recipientAddress" name="recipientAddress">
                    </div>
                    <div class="form-group">
                        <label for="recipientPostalCode">Postinumero</label>
                        <input type="text" id="recipientPostalCode" name="recipientPostalCode">
                    </div>
                    <div class="form-group">
                        <label for="recipientCity">Kaupunki</label>
                        <input type="text" id="recipientCity" name="recipientCity">
                    </div>
                </div>

                <h2>Maksutiedot</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="accountNumber">IBAN-tilinumero</label>
                        <input type="text" id="accountNumber" name="accountNumber">
                    </div>
                    <div class="form-group">
                        <label for="bic">BIC/SWIFT</label>
                        <input type="text" id="bic" name="bic">
                    </div>
                    <div class="form-group">
                        <label for="paymentReference">Viitenumero</label>
                        <input type="text" id="paymentReference" name="paymentReference" readonly style="background-color: #f8f9fa; cursor: not-allowed;">
                        <small style="color: var(--light-text); font-size: 0.85em;">Lasketaan automaattisesti laskun numeron perusteella</small>
                    </div>
                </div>

                <div class="checkbox-container">
                    <input type="checkbox" id="generateBarcode" name="generateBarcode" checked>
                    <label for="generateBarcode">Lisää viivakoodi</label>
                </div>

                <h2>Tuotteet ja palvelut</h2>
                <div id="products-container">
                    <!-- Tuotteet lisätään tähän dynaamisesti -->
                </div>
                
                <button type="button" id="add-product-btn" class="button-accent">Lisää uusi tuote/palvelu</button>

                <div class="form-row">
                    <div class="form-group">
                        <label for="taxRate">ALV-prosentti</label>
                        <select id="taxRate" name="taxRate">
                            <option value="0">0% (ALV-vapaa)</option>
                            <option value="10">10% (elintarvikkeet, kirjat)</option>
                            <option value="14">14% (ravintola, kulttuuripalvelut)</option>
                            <option value="25.5" selected>25.5% (yleinen ALV)</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="notes">Lisätiedot ja huomautukset</label>
                    <textarea id="notes" name="notes" rows="4"></textarea>
                </div>

                <div class="button-container">
                    <button type="button" id="create-pdf" class="button-success">Luo PDF-lasku</button>
                    <button type="button" id="save-sender-data" class="button-primary">Tallenna laskuttajan tiedot</button>
                    <button type="button" id="clear-sender-data" class="button-accent">Tyhjennä tallennetut tiedot</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let productCounter = 0;
        
        const senderFieldIds = [
            'senderName', 'senderYTunnus', 'senderAddress', 'senderPostalCode', 
            'senderCity', 'senderPhone', 'senderEmail', 'accountNumber', 'bic', 'taxRate'
        ];
        
        // Suomalaisen viitenumeron laskenta
        function calculateFinnishReference(base) {
            const cleanBase = base.replace(/\D/g, '');
            if (cleanBase.length < 3 || cleanBase.length > 19) return '';
            
            const multipliers = [7, 3, 1];
            let sum = 0;
            
            for (let i = 0; i < cleanBase.length; i++) {
                const digit = parseInt(cleanBase[cleanBase.length - 1 - i]);
                const multiplier = multipliers[i % 3];
                sum += digit * multiplier;
            }
            
            const nextTen = Math.ceil(sum / 10) * 10;
            let checkDigit = nextTen - sum;
            if (checkDigit === 10) checkDigit = 0;
            
            return cleanBase + checkDigit;
        }
        
        function updateReference() {
            const invoiceNumber = document.getElementById('invoiceNumber').value;
            const referenceField = document.getElementById('paymentReference');
            
            if (invoiceNumber.trim()) {
                const reference = calculateFinnishReference(invoiceNumber);
                if (reference) {
                    // Formatoidaan viitenumero ryhmiin luettavuuden parantamiseksi (vain näytössä)
                    const formatted = reference.replace(/(?=(?:\d{5})+(?!\d))(?=\d)/g, ' ');
                    referenceField.value = formatted;
                } else {
                    referenceField.value = '';
                }
            } else {
                referenceField.value = '';
            }
        }
        
        // Virtuaaliviivakoodin luonti
        function createVirtualBarcode(data) {
            try {
                const version = '4';
                
                let iban = (data.payment.accountNumber || '').replace(/\s+/g, '');
                if (iban.toUpperCase().startsWith('FI')) {
                    iban = iban.slice(2);
                }
                iban = iban.padStart(16, '0').substring(0, 16);
                
                const amountCents = Math.round(data.total * 100);
                const euros = Math.floor(amountCents / 100);
                const cents = amountCents % 100;
                const eurosStr = euros.toString().padStart(6, '0');
                const centsStr = cents.toString().padStart(2, '0');
                
                const reserved = '000';
                
                let reference = (data.payment.reference || '').replace(/\s+/g, '');
                reference = reference.padStart(20, '0').substring(0, 20);
                
                let dueDateStr = '000000';
                const dueDate = new Date(data.dueDate);
                if (!isNaN(dueDate.getTime())) {
                    const yy = dueDate.getFullYear().toString().slice(-2);
                    const mm = (dueDate.getMonth() + 1).toString().padStart(2, '0');
                    const dd = dueDate.getDate().toString().padStart(2, '0');
                    dueDateStr = yy + mm + dd;
                }
                
                const barcode = version + iban + eurosStr + centsStr + reserved + reference + dueDateStr;
                
                if (barcode.length !== 54) {
                    throw new Error(`Viivakoodin pituus ${barcode.length}, odotettu 54`);
                }
                
                return barcode;
            } catch (err) {
                console.error('Virhe viivakoodin luonnissa:', err);
                return '';
            }
        }
        
        // Viivakoodin generointi Canvas-elementissä
        function generateBarcode(text) {
            try {
                if (!text || text.trim() === '') {
                    throw new Error('Viivakoodin sisältö on tyhjä');
                }
                
                console.log('Generoidaan viivakoodi tekstille:', text);
                
                // Luo canvas-elementti
                const canvas = document.createElement('canvas');
                canvas.width = 600;
                canvas.height = 100;
                
                // Generoi viivakoodi käyttäen JsBarcode-kirjastoa
                JsBarcode(canvas, text, {
                    format: "CODE128",
                    width: 2,
                    height: 80,
                    displayValue: false,
                    background: "#ffffff",
                    lineColor: "#000000",
                    margin: 10
                });
                
                // Muunna canvas data URL:ksi
                const dataUrl = canvas.toDataURL('image/png');
                console.log('Viivakoodi luotu onnistuneesti');
                return dataUrl;
                
            } catch (err) {
                console.error('Viivakoodin generointi epäonnistui:', err.message);
                return null;
            }
        }
        
        // Lomakkeen alustus
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Alustetaan ammattimainen laskusorvi (viivakoodilla)");
            
            const today = new Date();
            document.getElementById('invoiceDate').valueAsDate = today;
            
            const dueDate = new Date(today);
            dueDate.setDate(today.getDate() + 14);
            document.getElementById('dueDate').valueAsDate = dueDate;
            
            loadSenderData();
            addProductRow();
            document.getElementById('invoiceNumber').focus();
            
            // Event listenerit
            document.getElementById('add-product-btn').addEventListener('click', addProductRow);
            document.getElementById('create-pdf').addEventListener('click', createPDF);
            document.getElementById('invoiceNumber').addEventListener('input', updateReference);
            
            document.getElementById('save-sender-data').addEventListener('click', function() {
                saveSenderData();
                showNotification('Laskuttajan tiedot tallennettu onnistuneesti!', 'success');
            });
            
            document.getElementById('clear-sender-data').addEventListener('click', clearSenderData);
        });
        
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.remove('hidden');
            
            setTimeout(function() {
                notification.classList.add('hidden');
            }, 4000);
        }
        
function saveSenderData() {
    console.log("Tallennetaan laskuttajan tiedot localStorage:een");
    
    try {
        // Tarkistetaan onko localStorage käytettävissä
        if (typeof(Storage) === "undefined") {
            console.warn("localStorage ei ole käytettävissä tässä selaimessa");
            showNotification('Tietojen tallennus ei ole mahdollista tässä selaimessa', 'error');
            return;
        }
        
        let savedCount = 0;
        
        // Tallennetaan jokainen laskuttajan kenttä erikseen
        senderFieldIds.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field && field.value.trim() !== '') {
                localStorage.setItem(`laskusorvi_${fieldId}`, field.value.trim());
                savedCount++;
            }
        });
        
        console.log(`Tallennettu ${savedCount} kenttää localStorage:een`);
        
        if (savedCount > 0) {
            // Tallennetaan myös tallennusaika
            localStorage.setItem('laskusorvi_lastSaved', new Date().toISOString());
        }
        
    } catch (error) {
        console.error("Virhe tallentaessa localStorage:een:", error);
        showNotification('Tietojen tallentaminen epäonnistui', 'error');
    }
}

function loadSenderData() {
    console.log("Ladataan laskuttajan tiedot localStorage:sta");
    
    try {
        // Tarkistetaan onko localStorage käytettävissä
        if (typeof(Storage) === "undefined") {
            console.log("localStorage ei ole käytettävissä");
            return;
        }
        
        let dataFound = false;
        let loadedCount = 0;
        
        // Ladataan jokainen laskuttajan kenttä erikseen
        senderFieldIds.forEach(fieldId => {
            const savedValue = localStorage.getItem(`laskusorvi_${fieldId}`);
            const field = document.getElementById(fieldId);
            
            if (savedValue && field) {
                field.value = savedValue;
                dataFound = true;
                loadedCount++;
            }
        });
        
        if (dataFound) {
            console.log(`Ladattu ${loadedCount} kenttää localStorage:sta`);
            
            // Tarkistetaan tallennusaika
            const lastSaved = localStorage.getItem('laskusorvi_lastSaved');
            if (lastSaved) {
                const savedDate = new Date(lastSaved);
                const timeAgo = Math.round((new Date() - savedDate) / (1000 * 60 * 60 * 24));
                
                if (timeAgo === 0) {
                    showNotification('Tallennetut laskuttajan tiedot ladattu! (tallennettu tänään)', 'success');
                } else if (timeAgo === 1) {
                    showNotification('Tallennetut laskuttajan tiedot ladattu! (tallennettu eilen)', 'success');
                } else if (timeAgo < 30) {
                    showNotification(`Tallennetut laskuttajan tiedot ladattu! (tallennettu ${timeAgo} päivää sitten)`, 'success');
                } else {
                    showNotification('Tallennetut laskuttajan tiedot ladattu!', 'success');
                }
            } else {
                showNotification('Tallennetut laskuttajan tiedot ladattu!', 'success');
            }
        } else {
            console.log("Tallennettuja laskuttajan tietoja ei löytynyt");
        }
        
    } catch (error) {
        console.error("Virhe ladatessa localStorage:sta:", error);
        showNotification('Tietojen lataaminen epäonnistui', 'error');
    }
}
function clearSenderData() {
    console.log("Tyhjennetään tallennetut laskuttajan tiedot");
    
    try {
        // Tarkistetaan onko localStorage käytettävissä
        if (typeof(Storage) === "undefined") {
            console.warn("localStorage ei ole käytettävissä");
            // Tyhjennetään vain lomake
            clearFormFields();
            return;
        }
        
        let removedCount = 0;
        
        // Tyhjennetään jokainen laskuttajan kenttä localStorage:sta
        senderFieldIds.forEach(fieldId => {
            const key = `laskusorvi_${fieldId}`;
            if (localStorage.getItem(key) !== null) {
                localStorage.removeItem(key);
                removedCount++;
            }
        });
        
        // Poistetaan myös tallennusaika
        localStorage.removeItem('laskusorvi_lastSaved');
        
        // Tyhjennetään lomakkeen kentät
        clearFormFields();
        
        console.log(`Poistettu ${removedCount} kenttää localStorage:sta`);
        showNotification('Tallennetut laskuttajan tiedot on tyhjennetty.', 'error');
        
    } catch (error) {
        console.error("Virhe tyhjentäessä localStorage:ta:", error);
        // Tyhjennetään ainakin lomake
        clearFormFields();
        showNotification('Lomake tyhjennetty (osittainen virhe tallennuksen tyhjentämisessä)', 'error');
    }
}

/**
 * Apufunktio lomakkeen kenttien tyhjentämiseen
 */
function clearFormFields() {
    senderFieldIds.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.value = '';
        }
    });
}


        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('fi-FI');
        }
        
        function formatNumber(number) {
            return Number(number).toFixed(2).replace('.', ',');
        }
        
        function addProductRow() {
            const productsContainer = document.getElementById('products-container');
            
            const productItem = document.createElement('div');
            productItem.className = 'product-item';
            productItem.id = `product-${productCounter}`;
            
            productItem.innerHTML = `
                <div class="form-row">
                    <div class="form-group">
                        <label for="productDescription${productCounter}">Tuotteen/palvelun kuvaus</label>
                        <input type="text" id="productDescription${productCounter}" name="productDescription${productCounter}">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="productQuantity${productCounter}">Määrä</label>
                        <input type="number" id="productQuantity${productCounter}" name="productQuantity${productCounter}" value="1" min="1" step="1">
                    </div>
                    <div class="form-group">
                        <label for="productUnit${productCounter}">Yksikkö</label>
                        <input type="text" id="productUnit${productCounter}" name="productUnit${productCounter}" value="kpl">
                    </div>
                    <div class="form-group">
                        <label for="productPrice${productCounter}">Yksikköhinta (€, ALV 0%)</label>
                        <input type="number" id="productPrice${productCounter}" name="productPrice${productCounter}" min="0" step="0.01">
                    </div>
                </div>
            `;
            
            if (productCounter > 0) {
                const removeButton = document.createElement('button');
                removeButton.type = 'button';
                removeButton.className = 'button-accent';
                removeButton.style.marginTop = '1rem';
                removeButton.textContent = 'Poista tämä tuote';
                removeButton.dataset.id = `product-${productCounter}`;
                
                removeButton.addEventListener('click', function() {
                    const productId = this.dataset.id;
                    const productToRemove = document.getElementById(productId);
                    if (productToRemove) {
                        productsContainer.removeChild(productToRemove);
                        showNotification('Tuote poistettu', 'error');
                    }
                });
                
                productItem.appendChild(removeButton);
            }
            
            productsContainer.appendChild(productItem);
            document.getElementById(`productDescription${productCounter}`).focus();
            productCounter++;
        }
        
        function collectFormData() {
            const formData = {
                invoiceNumber: document.getElementById('invoiceNumber').value,
                invoiceDate: document.getElementById('invoiceDate').value,
                dueDate: document.getElementById('dueDate').value,
                sender: {
                    name: document.getElementById('senderName').value,
                    ytunnus: document.getElementById('senderYTunnus').value,
                    address: document.getElementById('senderAddress').value,
                    postalCode: document.getElementById('senderPostalCode').value,
                    city: document.getElementById('senderCity').value,
                    phone: document.getElementById('senderPhone').value,
                    email: document.getElementById('senderEmail').value
                },
                recipient: {
                    name: document.getElementById('recipientName').value,
                    ytunnus: document.getElementById('recipientYTunnus').value,
                    address: document.getElementById('recipientAddress').value,
                    postalCode: document.getElementById('recipientPostalCode').value,
                    city: document.getElementById('recipientCity').value
                },
                payment: {
                    accountNumber: document.getElementById('accountNumber').value,
                    bic: document.getElementById('bic').value,
                    reference: document.getElementById('paymentReference').value.replace(/\s+/g, '')
                },
                products: [],
                taxRate: parseFloat(document.getElementById('taxRate').value),
                notes: document.getElementById('notes').value,
                generateBarcode: document.getElementById('generateBarcode').checked
            };
            
            // Kerää tuotteet
            const productItems = document.querySelectorAll('.product-item');
            productItems.forEach((item) => {
                const idNum = item.id.split('-')[1];
                const description = document.getElementById(`productDescription${idNum}`)?.value || '';
                const quantity = parseFloat(document.getElementById(`productQuantity${idNum}`)?.value || '1');
                const unit = document.getElementById(`productUnit${idNum}`)?.value || 'kpl';
                const price = parseFloat(document.getElementById(`productPrice${idNum}`)?.value || '0');
                
                if (description.trim()) {
                    const total = quantity * price;
                    formData.products.push({ description, quantity, unit, price, total });
                }
            });
            
            // Laske summat
            let subtotal = 0;
            formData.products.forEach(product => {
                subtotal += product.total;
            });
            
            const taxAmount = subtotal * (formData.taxRate / 100);
            const total = subtotal + taxAmount;
            
            formData.subtotal = subtotal;
            formData.taxAmount = taxAmount;
            formData.total = total;
            
            return formData;
        }
        
        // PDF-luonti viivakoodilla
        function createPDF() {
            saveSenderData();
            const data = collectFormData();
            
            console.log('Luodaan PDF seuraavilla tiedoilla:', data);
            
            // Validointi
            if (!data.invoiceNumber) {
                showNotification('Laskun numero puuttuu!', 'error');
                return;
            }
            if (!data.sender.name) {
                showNotification('Laskuttajan nimi puuttuu!', 'error');
                return;
            }
            if (!data.recipient.name) {
                showNotification('Asiakkaan nimi puuttuu!', 'error');
                return;
            }
            if (data.products.length === 0) {
                showNotification('Lisää vähintään yksi tuote!', 'error');
                return;
            }
            if (!data.payment.accountNumber) {
                showNotification('IBAN-tilinumero puuttuu!', 'error');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });
            
            // PDF metatiedot
            doc.setProperties({
                title: `Lasku ${data.invoiceNumber}`,
                subject: `Lasku ${data.sender.name} - ${data.recipient.name}`,
                creator: 'PDF-laskusorvi',
                author: data.sender.name || 'Laskuttaja'
            });
            
            // Luo PDF layout
            createImprovedLayout(doc, data);
        }
        
        function createImprovedLayout(doc, data) {
            const margin = 20;
            const lineHeight = 6;
            const pageWidth = 210;
            const pageHeight = 297;
            
            let y = margin;
            
            // --- HEADER ---
            doc.setFont("helvetica", "bold");
            doc.setFontSize(24);
            doc.text('LASKU', pageWidth / 2, y, { align: 'center' });
            
            doc.setFontSize(10);
            doc.text(`Sivu 1/1`, pageWidth - margin, y, { align: 'right' });
            
            y += 15;
            
            // --- LASKUTTAJAN TIEDOT VASEMMALLA ---
            doc.setFont("helvetica", "bold");
            doc.setFontSize(12);
            if (data.sender.name) {
                doc.text(data.sender.name, margin, y);
                y += lineHeight;
            }
            
            doc.setFont("helvetica", "normal");
            doc.setFontSize(10);
            
            if (data.sender.address) {
                doc.text(data.sender.address, margin, y);
                y += lineHeight;
            }
            if (data.sender.postalCode || data.sender.city) {
                doc.text(`${data.sender.postalCode || ''} ${data.sender.city || ''}`, margin, y);
                y += lineHeight;
            }
            
            // --- LASKUN TIEDOT OIKEALLA ---
            const rightColX = 120;
            let rightY = margin + 15;
            
            // Taulukon header
            doc.setFillColor(248, 249, 250);
            doc.rect(rightColX, rightY, 70, lineHeight * 8, 'F');
            doc.setDrawColor(200, 200, 200);
            doc.rect(rightColX, rightY, 70, lineHeight * 8, 'S');
            
            // Taulukon tiedot
            const infoRows = [
                ['Asiakas', data.recipient.name || ''],
                ['Lasku No.', data.invoiceNumber || ''],
                ['Laskun pvm', formatDate(data.invoiceDate)],
                ['Eräpäivä', formatDate(data.dueDate)],
                ['Viitenumero', data.payment.reference || ''],
                ['ALV-%', data.taxRate + '%'],
                ['Summa EUR', formatNumber(data.total)]
            ];
            
            doc.setFont("helvetica", "normal");
            doc.setFontSize(9);
            
            infoRows.forEach((row, index) => {
                const rowY = rightY + 5 + (index * lineHeight);
                doc.setFont("helvetica", "bold");
                doc.text(row[0], rightColX + 2, rowY);
                doc.setFont("helvetica", "normal");
                doc.text(row[1], rightColX + 25, rowY);
            });
            
            y = rightY + (lineHeight * 9);
            
            // --- ASIAKKAAN TIEDOT ---
            y += 10;
            doc.setFont("helvetica", "bold");
            doc.setFontSize(12);
            doc.text('Laskutettava', margin, y);
            
            doc.setFont("helvetica", "normal");
            doc.setFontSize(10);
            y += lineHeight;
            
            if (data.recipient.name) {
                doc.text(data.recipient.name, margin, y);
                y += lineHeight;
            }
            if (data.recipient.ytunnus) {
                doc.text(`Y-tunnus: ${data.recipient.ytunnus}`, margin, y);
                y += lineHeight;
            }
            if (data.recipient.address) {
                doc.text(data.recipient.address, margin, y);
                y += lineHeight;
            }
            if (data.recipient.postalCode || data.recipient.city) {
                doc.text(`${data.recipient.postalCode || ''} ${data.recipient.city || ''}`, margin, y);
                y += lineHeight;
            }
            
            // --- TUOTETAULUKKO ---
            y += 15;
            
            doc.setFont("helvetica", "bold");
            doc.setFontSize(12);
            doc.text('Tuotteet / Palvelut', margin, y);
            y += 8;
            
            // Taulukon otsikot
            const colWidths = [80, 15, 20, 25, 30];
            const headers = ['Nimike', 'Määrä', 'Yksikkö', 'A-Hinta', 'Yhteensä'];
            
            // Otsikkorivi tausta
            doc.setFillColor(248, 249, 250);
            doc.rect(margin, y - 4, colWidths.reduce((a, b) => a + b, 0), lineHeight, 'F');
            doc.setDrawColor(200, 200, 200);
            doc.rect(margin, y - 4, colWidths.reduce((a, b) => a + b, 0), lineHeight, 'S');
            
            doc.setFont("helvetica", "bold");
            doc.setFontSize(9);
            
            let xPos = margin;
            headers.forEach((header, i) => {
                doc.text(header, xPos + 2, y);
                xPos += colWidths[i];
            });
            
            y += lineHeight;
            
            // Tuoterivit
            doc.setFont("helvetica", "normal");
            data.products.forEach(product => {
                xPos = margin;
                
                // Rivien reunat
                doc.setDrawColor(230, 230, 230);
                doc.rect(margin, y - 4, colWidths.reduce((a, b) => a + b, 0), lineHeight, 'S');
                
                doc.text(product.description, xPos + 2, y);
                xPos += colWidths[0];
                
                doc.text(String(product.quantity), xPos + 2, y);
                xPos += colWidths[1];
                
                doc.text(product.unit, xPos + 2, y);
                xPos += colWidths[2];
                
                doc.text(formatNumber(product.price), xPos + 2, y);
                xPos += colWidths[3];
                
                doc.text(formatNumber(product.total), xPos + 2, y);
                
                y += lineHeight;
            });
            
            // --- YHTEENVETO ---
            y += 10;
            
            const summaryRows = [
                ['Verokanta', 'Veroton summa', 'Veron osuus', 'Verollinen summa'],
                [`${data.taxRate} %`, formatNumber(data.subtotal), formatNumber(data.taxAmount), formatNumber(data.total)],
                ['', formatNumber(data.subtotal), formatNumber(data.taxAmount), formatNumber(data.total)]
            ];
            
            summaryRows.forEach((row, index) => {
                if (index === 0) {
                    // Otsikkorivi
                    doc.setFillColor(248, 249, 250);
                    doc.rect(margin + 80, y - 3, 90, lineHeight, 'F');
                    doc.setFont("helvetica", "bold");
                } else if (index === 2) {
                    // Loppusumma
                    doc.setFont("helvetica", "bold");
                } else {
                    doc.setFont("helvetica", "normal");
                }
                
                doc.setDrawColor(200, 200, 200);
                doc.rect(margin + 80, y - 3, 90, lineHeight, 'S');
                
                let summaryX = margin + 82;
                const summaryColWidth = 22;
                
                row.forEach(cell => {
                    doc.text(cell, summaryX, y);
                    summaryX += summaryColWidth;
                });
                
                y += lineHeight;
            });
            
            // --- MAKSUTIEDOT ---
            y += 15;
            
            // Tilisiirto-laatikko
            const transferBoxHeight = 40;
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(0.5);
            doc.rect(margin, y, pageWidth - (margin * 2), transferBoxHeight, 'S');
            
            // "TILISIIRTO" -otsikko
            doc.setFont("helvetica", "bold");
            doc.setFontSize(10);
            doc.text('TILISIIRTO', margin + 5, y + 8);
            
            // Maksutiedot
            doc.setFont("helvetica", "normal");
            doc.setFontSize(9);
            
            const paymentInfoY = y + 15;
            doc.text('Saajan tilinumero', margin + 5, paymentInfoY);
            doc.text('IBAN', margin + 5, paymentInfoY + 5);
            doc.text(data.payment.accountNumber || '', margin + 5, paymentInfoY + 10);
            
            doc.text('BIC', margin + 60, paymentInfoY);
            doc.text(data.payment.bic || '', margin + 60, paymentInfoY + 5);
            
            doc.text('Saaja', margin + 5, paymentInfoY + 18);
            doc.text(data.sender.name || '', margin + 5, paymentInfoY + 23);
            
            // Maksajan tiedot oikealla
            doc.text('Maksajan nimi ja osoite', margin + 100, paymentInfoY);
            doc.text(data.recipient.name || '', margin + 100, paymentInfoY + 5);
            if (data.recipient.address) {
                doc.text(data.recipient.address, margin + 100, paymentInfoY + 10);
            }
            if (data.recipient.postalCode || data.recipient.city) {
                doc.text(`${data.recipient.postalCode || ''} ${data.recipient.city || ''}`, margin + 100, paymentInfoY + 15);
            }
            
            // Viitenumero ja summa
            doc.text('Viitenumero', margin + 5, paymentInfoY + 30);
            doc.text(data.payment.reference || '', margin + 30, paymentInfoY + 30);
            
            doc.text('EUR', pageWidth - margin - 20, paymentInfoY + 25);
            doc.setFont("helvetica", "bold");
            doc.setFontSize(12);
            doc.text(formatNumber(data.total), pageWidth - margin - 5, paymentInfoY + 30, { align: 'right' });
            
            y += transferBoxHeight + 10;
            
            // --- VIIVAKOODI ---
            if (data.generateBarcode) {
                // Virtuaaliviivakoodi
                const barcode = createVirtualBarcode(data);
                if (barcode) {
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(11);
                    doc.text('Virtuaaliviivakoodi', margin, y);
                    
                    y += 8;
                    doc.setFont("courier", "normal");
                    doc.setFontSize(10);
                    doc.text(barcode, margin, y);
                    
                    y += 15;
                    
                    // Generoi viivakoodi kuva
                    const barcodeDataUrl = generateBarcode(barcode);
                    if (barcodeDataUrl) {
                        console.log('Viivakoodi luotu onnistuneesti, lisätään PDF:ään...');
                        
                        try {
                            // Lisää viivakoodi PDF:ään
                            const barcodeWidth = 120;
                            const barcodeHeight = 20;
                            
                            doc.addImage(barcodeDataUrl, 'PNG', margin, y, barcodeWidth, barcodeHeight);
                            
                            console.log('Viivakoodi lisätty PDF:ään onnistuneesti');
                            
                            // Päivitä y-koordinaatti viivakoodin jälkeen
                            y += barcodeHeight + 10;
                            
                        } catch (imageError) {
                            console.error('Virhe viivakoodin lisäämisessä PDF:ään:', imageError);
                            showNotification('Viivakoodin lisääminen epäonnistui, mutta PDF luotiin', 'error');
                            y += 15;
                        }
                    } else {
                        console.error('Viivakoodin generointi epäonnistui');
                        showNotification('Viivakoodin luonti epäonnistui, mutta PDF luotiin', 'error');
                        y += 15;
                    }
                }
            }
            
            // Lisätiedot
            if (data.notes && data.notes.trim()) {
                const notesY = y + 10;
                
                // Tarkista ettei mene sivun ulkopuolelle
                if (notesY + 20 < pageHeight - margin) {
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(10);
                    doc.text('Lisätiedot:', margin, notesY);
                    
                    doc.setFont("helvetica", "normal");
                    doc.setFontSize(9);
                    const splitNotes = doc.splitTextToSize(data.notes, pageWidth - (margin * 2) - 35);
                    doc.text(splitNotes, margin, notesY + 6);
                } else {
                    // Jos ei mahdu, lisää uusi sivu
                    doc.addPage();
                    const newPageY = margin + 10;
                    
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(10);
                    doc.text('Lisätiedot:', margin, newPageY);
                    
                    doc.setFont("helvetica", "normal");
                    doc.setFontSize(9);
                    const splitNotes = doc.splitTextToSize(data.notes, pageWidth - (margin * 2));
                    doc.text(splitNotes, margin, newPageY + 6);
                }
            }
            
            // Tallenna PDF
            const filename = `lasku_${data.invoiceNumber}.pdf`;
            
            try {
                doc.save(filename);
                console.log('PDF tallennettu onnistuneesti:', filename);
                showNotification(`PDF-lasku "${filename}" luotu onnistuneesti! ${data.generateBarcode ? 'Viivakoodi toimii pankkisovelluksissa.' : ''}`, 'success');
            } catch (saveError) {
                console.error('PDF:n tallentaminen epäonnistui:', saveError);
                showNotification('PDF:n tallentaminen epäonnistui!', 'error');
            }
        }
    </script>
</body>
</html>