<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accessible Chess - Board or Text</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: Arial, sans-serif;
            line-height: 1.4;
            max-width: 600px;
            margin: 0 auto;
            padding: 10px;
            color: #333;
            background-color: #f0f0f0;
        }
        input:focus, button:focus, select:focus, [tabindex="-1"]:focus {
            outline: 3px solid #005fcc; outline-offset: 2px;
        }
        h1, h2 { margin-bottom: 0.8rem; text-align: center; }
        
        #setup-area, #game-area, #moves-container, #help-container {
            background-color: #ffffff; border-radius: 12px; padding: 1.2rem; margin: 10px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Chess Board Styles */
        #board-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            width: 100%;
            aspect-ratio: 1 / 1;
            border: 3px solid #444;
            margin: 10px 0;
            touch-action: manipulation;
        }
        .square {
            aspect-ratio: 1 / 1;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 7vw; /* Skaalautuu ruudun mukaan */
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }
        @media (min-width: 600px) { .square { font-size: 40px; } }

        .light { background-color: #f0d9b5; }
        .dark { background-color: #b58863; }
        .selected { outline: 4px solid #3dff3d !important; outline-offset: -4px; z-index: 2; }
        .last-move { background-color: rgba(255, 255, 0, 0.4); }

        .status-box {
            background-color: #e8f4f8; border: 2px solid #b8d8e8; border-radius: 8px;
            padding: 12px; margin-bottom: 10px; font-weight: bold; min-height: 50px;
            display: flex; align-items: center; justify-content: center; text-align: center;
        }

        .button-list { list-style: none; padding: 0; }
        .button-list li { margin-bottom: 10px; }

        button {
            background-color: #005fcc; color: white; padding: 12px;
            border: none; border-radius: 8px; font-size: 1rem; font-weight: bold;
            width: 100%; cursor: pointer; text-align: center;
        }
        .btn-secondary { background-color: #555; }
        button:active { transform: scale(0.98); }
        
        .hidden { display: none; }
        
        fieldset { border: 1px solid #ccc; padding: 10px; border-radius: 8px; margin-bottom: 15px; }
        legend { font-weight: bold; padding: 0 5px; }

        @media (prefers-color-scheme: dark) {
            body { background-color: #1a1a1a; color: #eee; }
            #setup-area, #game-area, #moves-container, #help-container { background-color: #2a2a2a; }
            .status-box { background-color: #1e2c33; border-color: #3d5a6d; }
            .light { background-color: #555; }
            .dark { background-color: #333; }
        }
    </style>
</head>
<body>

    <h1>Chess</h1>

    <div id="setup-area">
        <h2>Game Settings</h2>
        
        <fieldset>
            <legend>1. Select Control Method</legend>
            <label><input type="radio" name="inputMethod" value="board" checked> Interactive Board</label><br>
            <label><input type="radio" name="inputMethod" value="text"> Text Input (Nf3, e4...)</label>
        </fieldset>

        <fieldset>
            <legend>2. Engine Strength</legend>
            <select id="skillSelect" style="width:100%; padding:10px;">
                <option value="0">Beginner</option>
                <option value="10">Club Player</option>
                <option value="20" selected>Grandmaster</option>
            </select>
        </fieldset>

        <ul class="button-list">
            <li><button id="playWhite" onclick="startGame('w')">Play as White</button></li>
            <li><button onclick="startGame('b')">Play as Black</button></li>
            <li><button onclick="toggleHelp()" class="btn-secondary">Help / Instructions</button></li>
        </ul>
    </div>

    <div id="help-container" class="hidden">
        <h2 id="help-title" tabindex="-1">Instructions</h2>
        <div id="help-content"></div>
        <button onclick="toggleHelp()" class="btn-secondary" style="margin-top:15px">Back</button>
    </div>

    <div id="game-area" class="hidden">
        <div id="status" class="status-box" role="alert" aria-live="assertive">Ready to play.</div>

        <div id="board-container" class="hidden">
            <div id="board-grid" role="grid" aria-label="Chess Board"></div>
        </div>

        <div id="text-input-container" class="hidden">
            <label for="moveInput">Your move:</label>
            <input id="moveInput" type="text" style="width:100%; padding:15px; font-size:1.2rem; margin:10px 0;" placeholder="e.g. e4">
            <button onclick="handleTextMove()">Submit Move</button>
        </div>

        <ul class="button-list" style="margin-top:15px">
            <li><button onclick="announcePosition()" class="btn-secondary">Scan Board (Alt+P)</button></li>
            <li><button id="toggleMovesBtn" onclick="toggleMoves()" class="btn-secondary">Show Move List</button></li>
            <li><button onclick="location.reload()" class="btn-secondary">Quit Game</button></li>
        </ul>

        <div id="moves-container" class="hidden">
            <h3>Move List</h3>
            <ul id="moves-list" style="list-style:none; padding:0; max-height:150px; overflow-y:auto;"></ul>
        </div>
    </div>

    <script>
        const game = new Chess();
        let engine;
        let selectedSquare = null;
        let controlMethod = "board";
        let lastMoveText = "";

        const pieceUnicode = {
            'wk': '♔', 'wq': '♕', 'wr': '♖', 'wb': '♗', 'wn': '♘', 'wp': '♙',
            'bk': '♚', 'bq': '♛', 'br': '♜', 'bb': '♝', 'bn': '♞', 'bp': '♟'
        };

        window.onload = () => { document.getElementById('playWhite').focus(); };

        // Pikanäppäimet
        window.addEventListener('keydown', (e) => {
            if (e.altKey && e.key.toLowerCase() === 'r') updateStatus(lastMoveText);
            if (e.altKey && e.key.toLowerCase() === 'p') announcePosition();
        });

        function updateStatus(msg) {
            const s = document.getElementById('status');
            s.innerText = "";
            setTimeout(() => { s.innerText = msg; }, 50);
        }

        function startGame(color) {
            controlMethod = document.querySelector('input[name="inputMethod"]:checked').value;
            const skill = document.getElementById('skillSelect').value;
            
            document.getElementById('setup-area').classList.add('hidden');
            document.getElementById('game-area').classList.remove('hidden');

            if (controlMethod === "board") {
                document.getElementById('board-container').classList.remove('hidden');
                renderBoard();
            } else {
                document.getElementById('text-input-container').classList.remove('hidden');
                const input = document.getElementById('moveInput');
                input.addEventListener('keydown', (e) => { if(e.key === 'Enter') handleTextMove(); });
                input.focus();
            }

            setHelpText();
            initEngine(skill);

            if (color === 'b') setTimeout(makeEngineMove, 1000);
        }

        function initEngine(skill) {
            try {
                const blob = new Blob(["importScripts('https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.js');"], {type: 'application/javascript'});
                engine = new Worker(URL.createObjectURL(blob));
                engine.postMessage('setoption name Skill Level value ' + skill);
            } catch (e) { console.error("Engine failed", e); }
        }

        function renderBoard() {
            const grid = document.getElementById('board-grid');
            grid.innerHTML = '';
            const board = game.board();

            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    const squareName = String.fromCharCode(97 + c) + (8 - r);
                    const piece = board[r][c];
                    const btn = document.createElement('button');
                    btn.className = `square ${(r + c) % 2 === 0 ? 'light' : 'dark'}`;
                    
                    if (selectedSquare === squareName) btn.classList.add('selected');
                    
                    const pName = piece ? (piece.color === 'w' ? 'white' : 'black') + ' ' + piece.type : 'empty';
                    btn.setAttribute('aria-label', `${squareName} ${pName}`);
                    btn.innerHTML = piece ? pieceUnicode[piece.color + piece.type] : '';
                    btn.onclick = () => handleSquareClick(squareName);
                    grid.appendChild(btn);
                }
            }
        }

        function handleSquareClick(sq) {
            if (!selectedSquare) {
                const p = game.get(sq);
                if (p && p.color === game.turn()) {
                    selectedSquare = sq;
                    updateStatus("Selected " + sq);
                    renderBoard();
                }
            } else {
                const move = game.move({ from: selectedSquare, to: sq, promotion: 'q' });
                selectedSquare = null;
                if (move) {
                    if (window.navigator.vibrate) window.navigator.vibrate(50); // Haptic feedback
                    finalizeMove(move);
                    setTimeout(makeEngineMove, 600);
                } else {
                    updateStatus("Invalid move.");
                }
                renderBoard();
            }
        }

        function handleTextMove() {
            const input = document.getElementById('moveInput');
            const move = game.move(input.value.trim());
            if (move) {
                input.value = '';
                finalizeMove(move);
                setTimeout(makeEngineMove, 600);
            } else {
                updateStatus("Invalid move notation.");
            }
        }

        function makeEngineMove() {
            if (game.game_over()) return;
            engine.onmessage = (e) => {
                if (e.data.includes('bestmove')) {
                    const move = game.move(e.data.split(' ')[1], { sloppy: true });
                    finalizeMove(move);
                    if (controlMethod === "board") renderBoard();
                }
            };
            engine.postMessage('position fen ' + game.fen());
            engine.postMessage('go depth 12');
        }

        function finalizeMove(move) {
            const color = game.turn() === 'w' ? "black" : "white";
            lastMoveText = color + " " + move.san + (game.in_checkmate() ? " - checkmate" : "");
            updateStatus(lastMoveText);
            updateMovesList();
        }

        function updateMovesList() {
            const list = document.getElementById('moves-list');
            list.innerHTML = '';
            const history = game.history();
            for (let i = 0; i < history.length; i += 2) {
                const li = document.createElement('li');
                li.textContent = `${Math.floor(i/2)+1}. ${history[i]} ${history[i+1] || "..."}`;
                list.prepend(li); // Viimeisin ylhäällä
            }
        }

        function toggleMoves() {
            const m = document.getElementById('moves-container');
            m.classList.toggle('hidden');
        }

        function toggleHelp() {
            document.getElementById('help-container').classList.toggle('hidden');
            if(!document.getElementById('help-container').classList.contains('hidden')) {
                document.getElementById('help-title').focus();
            }
        }

        function setHelpText() {
            const h = document.getElementById('help-content');
            if (controlMethod === "board") {
                h.innerHTML = "<ul><li>Tap a piece to select it.</li><li>Tap a target square to move.</li><li>Alt+R: Repeat last move.</li><li>Alt+P: Scan board.</li></ul>";
            } else {
                h.innerHTML = "<ul><li>Type move (e.g., e4, Nf3, O-O).</li><li>Press Enter or Submit.</li><li>Alt+R: Repeat last move.</li></ul>";
            }
        }

        function announcePosition() {
            const board = game.board();
            let pieces = [];
            for (let r=0; r<8; r++) {
                for (let c=0; c<8; c++) {
                    const p = board[r][c];
                    if (p) pieces.push(`${p.color==='w'?'White':'Black'} ${p.type} ${String.fromCharCode(97+c)}${8-r}`);
                }
            }
            updateStatus("Board status: " + pieces.join(", "));
        }
    </script>
</body>
</html>