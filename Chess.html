<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accessible Chess</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: Arial, Helvetica, sans-serif;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
            padding: 1rem;
            color: #333;
            background-color: #f9f9f9;
        }
        input:focus, button:focus, select:focus, [tabindex="-1"]:focus {
            outline: 3px solid #005fcc; outline-offset: 2px;
        }
        h1 { font-size: 1.8rem; margin-bottom: 1rem; color: #202020; }
        h2 { font-size: 1.4rem; margin-bottom: 0.8rem; color: #303030; }
        
        #setup-area, #game-area, #moves-container, #help-container {
            background-color: #ffffff; border-radius: 10px; padding: 1.5rem; margin: 1rem 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); animation: fadeIn 0.3s ease-in-out;
        }

        .button-list { list-style: none; padding: 0; margin-top: 1rem; display: flex; flex-wrap: wrap; gap: 10px; }
        .button-list li { display: block; }

        .status-box {
            background-color: #e8f4f8; border: 1px solid #b8d8e8; border-radius: 8px;
            padding: 1rem; margin-bottom: 1rem; font-weight: 600;
        }
        
        #moves-list { list-style: none; padding: 0; }
        #moves-list li { padding: 0.5rem 0; border-bottom: 1px solid #eee; }

        input[type="text"], select {
            width: 100%; padding: 0.8rem; margin-bottom: 1rem; border: 1px solid #ccc;
            border-radius: 6px; font-size: 1rem; display: block;
        }

        button {
            background-color: #005fcc; color: #ffffff; padding: 0.8rem 1.2rem;
            border: none; border-radius: 6px; cursor: pointer; font-size: 1rem;
            font-weight: 600; transition: background-color 0.2s;
            min-width: 160px; text-align: center;
        }
        button:hover:not(:disabled) { background-color: #004799; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .btn-secondary { background-color: #6c757d; }
        .btn-secondary:hover:not(:disabled) { background-color: #5a6268; }
        
        .hidden { display: none; }

        @media (prefers-color-scheme: dark) {
            body { background-color: #121212; color: #e0e0e0; }
            h1, h2 { color: #f0f0f0; }
            #setup-area, #game-area, #moves-container, #help-container { background-color: #1e1e1e; }
            .status-box { background-color: #1a2c35; border-color: #2a4658; color: #e0e0e0; }
            input[type="text"], select { background-color: #2a2a2a; border-color: #444; color: #e0e0e0; }
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <h1>Chess</h1>

    <div id="setup-area">
        <h2>Game Settings</h2>
        <div role="group" aria-labelledby="engine-label">
            <label id="engine-label" for="skillSelect">Opponent Skill Level:</label>
            <select id="skillSelect">
                <option value="0">Beginner</option>
                <option value="10">Intermediate</option>
                <option value="20" selected>Grandmaster (Stockfish Max)</option>
            </select>
        </div>

        <ul class="button-list">
            <li><button id="defaultAction" onclick="startGame('w')">Play as White</button></li>
            <li><button onclick="startGame('b')">Play as Black</button></li>
            <li><button onclick="startGame('auto')" class="btn-secondary">Watch: CPU vs CPU</button></li>
            <li>
                <button onclick="document.getElementById('fileInput').click()" class="btn-secondary">Load PGN</button>
                <input type="file" id="fileInput" class="hidden" accept=".pgn" onchange="loadGame(event)">
            </li>
            <li><button id="helpBtnSetup" onclick="toggleHelp('helpBtnSetup')" class="btn-secondary">Help</button></li>
        </ul>
    </div>

    <div id="help-container" class="hidden">
        <h2 id="help-title" tabindex="-1">Instructions</h2>
        <p>Accessible chess for screen readers.</p>
        <ul style="margin: 1rem 0 1rem 1.5rem;">
            <li><strong>Undo:</strong> Takes back the last moves.</li>
            <li><strong>Hotkeys:</strong> <strong>Alt + R</strong> repeats last move, <strong>Alt + P</strong> reads all pieces.</li>
        </ul>
        <button id="closeHelpBtn" onclick="toggleHelp()" class="btn-secondary">Close Help</button>
    </div>

    <div id="game-area" class="hidden">
        <div id="status" class="status-box" role="alert" aria-live="assertive">Ready.</div>

        <div id="user-input-section">
            <label for="moveInput">Enter move:</label>
            <input id="moveInput" type="text" autocomplete="off" placeholder="e.g. e4">
            <button id="sendMoveBtn" onclick="handleUserMove()">Move</button>
        </div>

        <ul class="button-list">
            <li><button id="undoBtn" onclick="undoMove()" class="btn-secondary">Undo Move</button></li>
            <li><button onclick="saveGame()" class="btn-secondary">Save (PGN)</button></li>
            <li><button onclick="announcePosition()" class="btn-secondary">Read Board</button></li>
            <li><button id="toggleMovesBtn" onclick="toggleMoves()" class="btn-secondary">Show Moves</button></li>
            <li><button onclick="location.reload()" class="btn-secondary">New Game</button></li>
        </ul>

        <div id="moves-container" class="hidden">
            <h2>Move List</h2>
            <ul id="moves-list"></ul>
        </div>
    </div>

    <script>
        const game = new Chess();
        let mode = 'w', engine, lastMoveText = "", lastFocusedBtn = null, isEngineThinking = false;

        window.onload = () => { document.getElementById('defaultAction').focus(); };

        window.addEventListener('keydown', (e) => {
            if (e.altKey) {
                if (e.key.toLowerCase() === 'r') { e.preventDefault(); updateStatus(lastMoveText || "No moves yet."); }
                if (e.key.toLowerCase() === 'p') { e.preventDefault(); announcePosition(); }
            }
        });

        try {
            const blob = new Blob(["importScripts('https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.js');"], {type: 'application/javascript'});
            engine = new Worker(URL.createObjectURL(blob));
        } catch (e) { console.error("Engine error:", e); }

        function updateStatus(msg) { 
            const status = document.getElementById('status');
            status.innerText = ""; 
            setTimeout(() => { status.innerText = msg; }, 50);
        }

        function startGame(startMode) {
            mode = startMode;
            document.getElementById('setup-area').style.display = 'none';
            document.getElementById('game-area').classList.remove('hidden');
            const moveInput = document.getElementById('moveInput');
            moveInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleUserMove(); });
            if (mode === 'auto') {
                document.getElementById('user-input-section').classList.add('hidden');
                setTimeout(makeEngineMove, 1000);
            } else {
                moveInput.focus();
                if (mode === 'b') setTimeout(makeEngineMove, 1000);
            }
        }

        function undoMove() {
            if (isEngineThinking) return;

            // Peru kaksi puolisirtoa
            game.undo();
            game.undo();
            
            updateMovesDisplay();
            
            const history = game.history();
            if (history.length > 0) {
                const lastMove = history[history.length - 1];
                const turnColor = game.turn() === 'w' ? "Black" : "White";
                lastMoveText = `Move cancelled. Last move was ${turnColor} ${lastMove}.`;
                updateStatus(lastMoveText);
            } else {
                // KORJAUS: Jos palattiin alkuun ja pelaaja on musta, koneen pit채채 tehd채 avaus uudelleen
                if (mode === 'b') {
                    updateStatus("Move cancelled. Restarting engine opening...");
                    setTimeout(makeEngineMove, 1000);
                } else {
                    lastMoveText = "Move cancelled. Back at the start. Your turn.";
                    updateStatus(lastMoveText);
                }
            }
        }

        function handleUserMove() {
            if (isEngineThinking) return;
            const input = document.getElementById('moveInput');
            let val = input.value.trim();
            if (!val) return;
            if (/^[nbrqk]/.test(val)) val = val.charAt(0).toUpperCase() + val.slice(1);
            let move = game.move(val);
            if (move === null && /^[a-h][18]$/.test(val)) move = game.move(val + "=Q");
            if (move === null) { updateStatus("Illegal: " + val); return; }
            input.value = '';
            finalizeMove(move);
            if (!game.game_over()) setTimeout(makeEngineMove, 600);
            input.focus();
        }

        function makeEngineMove() {
            if (game.game_over()) return;
            isEngineThinking = true;
            document.getElementById('undoBtn').disabled = true;

            // Satunnainen avaus jos lauta on tyhj채
            if (game.history().length === 0) {
                const move = game.move(['e4', 'd4', 'Nf3', 'c4'][Math.floor(Math.random() * 4)]);
                finalizeMove(move);
                finishTurn();
                if (mode === 'auto') setTimeout(makeEngineMove, 1500);
                return;
            }

            engine.onmessage = (event) => {
                if (event.data.includes('bestmove')) {
                    const moveText = event.data.split(' ')[1];
                    const move = game.move(moveText, { sloppy: true });
                    finalizeMove(move);
                    finishTurn();
                    if (mode === 'auto' && !game.game_over()) setTimeout(makeEngineMove, 1500);
                }
            };
            engine.postMessage('position fen ' + game.fen());
            engine.postMessage('go depth 12');
        }

        function finishTurn() {
            isEngineThinking = false;
            document.getElementById('undoBtn').disabled = false;
        }

        function finalizeMove(move) {
            const turn = game.turn() === 'w' ? "black" : "white";
            updateMovesDisplay();
            lastMoveText = turn + " " + move.san + (game.in_checkmate() ? " - checkmate" : "");
            updateStatus(lastMoveText);
        }

        function updateMovesDisplay() {
            const history = game.history();
            const list = document.getElementById('moves-list');
            list.innerHTML = "";
            for (let i = 0; i < history.length; i += 2) {
                const li = document.createElement('li');
                li.textContent = `${Math.floor(i / 2) + 1}. ${history[i]} ${history[i + 1] || "..."}`;
                list.appendChild(li);
            }
        }

        function announcePosition() {
            const board = game.board();
            let p = [];
            const names = {'p':'Pawn','n':'Knight','b':'Bishop','r':'Rook','q':'Queen','k':'King'};
            board.forEach((row, r) => {
                row.forEach((pc, c) => {
                    if (pc) p.push((pc.color==='w'?'White ':'Black ')+names[pc.type]+' '+String.fromCharCode(97+c)+(8-r));
                });
            });
            updateStatus("Position: " + p.join(", "));
        }

        function saveGame() {
            const blob = new Blob([game.pgn()], { type: 'text/plain' });
            const a = document.createElement('a');
            a.download = `chess_${new Date().getTime()}.pgn`;
            a.href = window.URL.createObjectURL(blob);
            a.click();
        }

        function loadGame(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                if (game.load_pgn(ev.target.result)) {
                    updateMovesDisplay(); startGame('w'); updateStatus("Loaded. Your turn.");
                } else alert("Invalid PGN.");
            };
            reader.readAsText(file);
        }

        function toggleHelp(tid) {
            const h = document.getElementById('help-container');
            if (h.classList.contains('hidden')) { lastFocusedBtn = tid; h.classList.remove('hidden'); document.getElementById('help-title').focus(); }
            else { h.classList.add('hidden'); if (lastFocusedBtn) document.getElementById(lastFocusedBtn).focus(); }
        }

        function toggleMoves() {
            document.getElementById('moves-container').classList.toggle('hidden');
        }
    </script>
</body>
</html>