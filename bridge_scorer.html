<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bridge Score Calculator</title>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
            line-height: 1.6;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        
        h2 {
            color: #34495e;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-top: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
        }
        
        button {
            background-color: #3498db;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        button:focus {
            outline: 2px solid #2980b9;
            outline-offset: 2px;
        }
        
        .danger-btn {
            background-color: #e74c3c;
        }
        
        .danger-btn:hover {
            background-color: #c0392b;
        }
        
        .result {
            background-color: #ecf0f1;
            padding: 20px;
            border-radius: 5px;
            margin-top: 20px;
            border-left: 4px solid #3498db;
        }
        
        .score-history {
            margin-top: 30px;
        }
        
        .score-item {
            background-color: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            border-left: 4px solid #27ae60;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
        }
        
        .scoring-system {
            background-color: #e8f6f3;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .error {
            color: #e74c3c;
            font-weight: bold;
            margin-top: 10px;
        }
        
        .suits {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        @media (max-width: 600px) {
            .suits {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 20px;
            }
        }
        
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        .storage-info {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Bridge Score Calculator</h1>
        
        <div class="storage-info">
            <strong>LocalStorage Version:</strong> Your scores are automatically saved to your browser's local storage and will persist between sessions.
        </div>
        
        <div class="scoring-system">
            <h2>Scoring System</h2>
            <div class="form-group">
                <label for="scoringType">Select scoring type:</label>
                <select id="scoringType" aria-describedby="scoringHelp">
                    <option value="contract">Contract Bridge</option>
                    <option value="imps">IMPs (International Match Points)</option>
                </select>
                <div id="scoringHelp" class="sr-only">Choose between Contract Bridge scoring or IMPs scoring system</div>
            </div>
        </div>
        
        <h2>Contract Information</h2>
        <form id="bridgeForm" role="form" aria-labelledby="contract-info">
            <div class="form-group">
                <label for="level">Contract Level (1-7):</label>
                <input type="number" id="level" min="1" max="7" required aria-describedby="levelHelp">
                <div id="levelHelp" class="sr-only">Enter the contract level from 1 to 7</div>
            </div>
            
            <div class="form-group">
                <label for="suit">Suit:</label>
                <select id="suit" required aria-describedby="suitHelp">
                    <option value="">Select suit</option>
                    <option value="clubs">Clubs</option>
                    <option value="diamonds">Diamonds</option>
                    <option value="hearts">Hearts</option>
                    <option value="spades">Spades</option>
                    <option value="notrump">No Trump</option>
                </select>
                <div id="suitHelp" class="sr-only">Select the suit of the contract</div>
            </div>
            
            <div class="form-group">
                <label for="tricksWon">Tricks Won (0-13):</label>
                <input type="number" id="tricksWon" min="0" max="13" required aria-describedby="tricksHelp">
                <div id="tricksHelp" class="sr-only">Enter the number of tricks actually won</div>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="doubled" aria-describedby="doubledHelp">
                <label for="doubled">Doubled</label>
                <div id="doubledHelp" class="sr-only">Check if the contract was doubled</div>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="redoubled" aria-describedby="redoubledHelp">
                <label for="redoubled">Redoubled</label>
                <div id="redoubledHelp" class="sr-only">Check if the contract was redoubled</div>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="vulnerable" aria-describedby="vulnerableHelp">
                <label for="vulnerable">Vulnerable</label>
                <div id="vulnerableHelp" class="sr-only">Check if the declaring side was vulnerable</div>
            </div>
            
            <div id="impsSection" style="display: none;">
                <div class="form-group">
                    <label for="opponentScore">Opponent's Score:</label>
                    <input type="number" id="opponentScore" aria-describedby="opponentHelp">
                    <div id="opponentHelp" class="sr-only">Enter the opponent's score for IMP calculation</div>
                </div>
            </div>
            
            <button type="submit">Calculate Score</button>
        </form>
        
        <div id="result" class="result" style="display: none;" role="region" aria-live="polite" aria-label="Calculation result">
        </div>
        
        <div class="score-history">
            <h2>Score History</h2>
            <button type="button" id="clearScores" class="danger-btn" aria-describedby="clearHelp">Clear All Scores</button>
            <div id="clearHelp" class="sr-only">Remove all saved scores from history</div>
            <div id="scoreList" role="region" aria-live="polite" aria-label="Saved scores">
                <p>No scores saved yet.</p>
            </div>
        </div>
    </div>

    <script>
        // LocalStorage key for saving scores
        const STORAGE_KEY = 'bridgeScores';
        
        // IMP conversion table
        const impTable = [
            { min: 0, max: 10, imps: 0 },
            { min: 20, max: 40, imps: 1 },
            { min: 50, max: 80, imps: 2 },
            { min: 90, max: 120, imps: 3 },
            { min: 130, max: 160, imps: 4 },
            { min: 170, max: 210, imps: 5 },
            { min: 220, max: 260, imps: 6 },
            { min: 270, max: 310, imps: 7 },
            { min: 320, max: 360, imps: 8 },
            { min: 370, max: 420, imps: 9 },
            { min: 430, max: 490, imps: 10 },
            { min: 500, max: 590, imps: 11 },
            { min: 600, max: 740, imps: 12 },
            { min: 750, max: 890, imps: 13 },
            { min: 900, max: 1090, imps: 14 },
            { min: 1100, max: 1290, imps: 15 },
            { min: 1300, max: 1490, imps: 16 },
            { min: 1500, max: 1740, imps: 17 },
            { min: 1750, max: 1990, imps: 18 },
            { min: 2000, max: 2240, imps: 19 },
            { min: 2250, max: 2490, imps: 20 },
            { min: 2500, max: 2990, imps: 21 },
            { min: 3000, max: 3490, imps: 22 },
            { min: 3500, max: 3990, imps: 23 },
            { min: 4000, max: Infinity, imps: 24 }
        ];
        
        // Load scores from localStorage
        function loadScores() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                return saved ? JSON.parse(saved) : [];
            } catch (error) {
                console.error('Error loading scores from localStorage:', error);
                return [];
            }
        }
        
        // Save scores to localStorage
        function saveScores(scores) {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(scores));
            } catch (error) {
                console.error('Error saving scores to localStorage:', error);
                alert('Error saving scores. Your browser may have storage limitations.');
            }
        }
        
        function calculateContractScore(level, suit, tricksWon, doubled, redoubled, vulnerable) {
            const contractTricks = 6 + level;
            const tricksDiff = tricksWon - contractTricks;
            
            let score = 0;
            let details = [];
            
            if (tricksDiff >= 0) {
                // Contract made
                let basicScore = 0;
                
                // Basic scoring
                if (suit === 'notrump') {
                    basicScore = 40 + (level - 1) * 30;
                } else if (suit === 'clubs' || suit === 'diamonds') {
                    basicScore = level * 20;
                } else {
                    basicScore = level * 30;
                }
                
                // Apply double/redouble multipliers to basic score
                if (redoubled) {
                    basicScore *= 4;
                } else if (doubled) {
                    basicScore *= 2;
                }
                
                score += basicScore;
                details.push(`Basic score: ${basicScore}`);
                
                // Game bonus (based on original basic score, not doubled)
                let originalBasicScore = 0;
                if (suit === 'notrump') {
                    originalBasicScore = 40 + (level - 1) * 30;
                } else if (suit === 'clubs' || suit === 'diamonds') {
                    originalBasicScore = level * 20;
                } else {
                    originalBasicScore = level * 30;
                }
                
                if (originalBasicScore >= 100) {
                    const gameBonus = vulnerable ? 500 : 300;
                    score += gameBonus;
                    details.push(`Game bonus: ${gameBonus}`);
                } else {
                    score += 50;
                    details.push(`Part game bonus: 50`);
                }
                
                // Double/redouble bonus
                if (redoubled) {
                    score += 100;
                    details.push(`Redouble bonus: 100`);
                } else if (doubled) {
                    score += 50;
                    details.push(`Double bonus: 50`);
                }
                
                // Slam bonuses (only when contract is made)
                if (level === 6) {
                    const smallSlamBonus = vulnerable ? 750 : 500;
                    score += smallSlamBonus;
                    details.push(`Small slam bonus: ${smallSlamBonus}`);
                } else if (level === 7) {
                    const grandSlamBonus = vulnerable ? 1500 : 1000;
                    score += grandSlamBonus;
                    details.push(`Grand slam bonus: ${grandSlamBonus}`);
                }
                
                // Overtricks
                if (tricksDiff > 0) {
                    let overtrickScore = 0;
                    if (doubled || redoubled) {
                        const overtrickValue = vulnerable ? 200 : 100;
                        overtrickScore = tricksDiff * overtrickValue;
                        if (redoubled) overtrickScore *= 2;
                    } else {
                        if (suit === 'notrump') {
                            overtrickScore = tricksDiff * 30;
                        } else if (suit === 'clubs' || suit === 'diamonds') {
                            overtrickScore = tricksDiff * 20;
                        } else {
                            overtrickScore = tricksDiff * 30;
                        }
                    }
                    score += overtrickScore;
                    details.push(`Overtricks (${tricksDiff}): ${overtrickScore}`);
                }
                
            } else {
                // Contract failed
                const underTricks = Math.abs(tricksDiff);
                let penalty = 0;
                
                if (doubled || redoubled) {
                    if (vulnerable) {
                        // Vulnerable doubled penalties
                        if (underTricks === 1) {
                            penalty = 200;
                        } else if (underTricks <= 3) {
                            penalty = 200 + (underTricks - 1) * 300;
                        } else {
                            penalty = 200 + 2 * 300 + (underTricks - 3) * 300;
                        }
                    } else {
                        // Non-vulnerable doubled penalties
                        if (underTricks === 1) {
                            penalty = 100;
                        } else if (underTricks <= 3) {
                            penalty = 100 + (underTricks - 1) * 200;
                        } else {
                            penalty = 100 + 2 * 200 + (underTricks - 3) * 300;
                        }
                    }
                    if (redoubled) penalty *= 2;
                } else {
                    // Undoubled penalties
                    if (vulnerable) {
                        penalty = underTricks * 100;
                    } else {
                        penalty = underTricks === 1 ? 50 : 50 + (underTricks - 1) * 100;
                    }
                }
                
                score = -penalty;
                details.push(`Failed by ${underTricks} tricks: -${penalty}`);
            }
            
            return { score, details };
        }
        
        function convertToImps(scoreDiff) {
            const absScore = Math.abs(scoreDiff);
            for (let entry of impTable) {
                if (absScore >= entry.min && absScore <= entry.max) {
                    return scoreDiff >= 0 ? entry.imps : -entry.imps;
                }
            }
            return scoreDiff >= 0 ? 24 : -24;
        }
        
        function displayScores() {
            const scores = loadScores();
            const scoreList = document.getElementById('scoreList');
            
            if (scores.length === 0) {
                scoreList.innerHTML = '<p>No scores saved yet.</p>';
                return;
            }
            
            let html = '';
            scores.forEach((score, index) => {
                html += `
                    <div class="score-item" role="article" aria-label="Score ${index + 1}">
                        <strong>Score ${index + 1}:</strong> ${score.score}<br>
                        <small>
                            ${score.level}${score.suit.charAt(0).toUpperCase()} 
                            (${score.tricksWon} tricks)
                            ${score.doubled ? ' Doubled' : ''}
                            ${score.redoubled ? ' Redoubled' : ''}
                            ${score.vulnerable ? ' Vulnerable' : ''}
                            ${score.scoringType === 'imps' ? ` | IMPs: ${score.imps}` : ''}
                            <br>
                            <em>Saved: ${score.timestamp}</em>
                        </small>
                    </div>
                `;
            });
            
            scoreList.innerHTML = html;
        }
        
        document.getElementById('scoringType').addEventListener('change', function() {
            const impsSection = document.getElementById('impsSection');
            if (this.value === 'imps') {
                impsSection.style.display = 'block';
                document.getElementById('opponentScore').required = true;
            } else {
                impsSection.style.display = 'none';
                document.getElementById('opponentScore').required = false;
            }
        });
        
        document.getElementById('bridgeForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const level = parseInt(document.getElementById('level').value);
            const suit = document.getElementById('suit').value;
            const tricksWon = parseInt(document.getElementById('tricksWon').value);
            const doubled = document.getElementById('doubled').checked;
            const redoubled = document.getElementById('redoubled').checked;
            const vulnerable = document.getElementById('vulnerable').checked;
            const scoringType = document.getElementById('scoringType').value;
            
            // Auto-check doubled if redoubled is selected
            if (redoubled && !doubled) {
                document.getElementById('doubled').checked = true;
            }
            
            const result = calculateContractScore(level, suit, tricksWon, doubled, redoubled, vulnerable);
            let displayText = `<h3>Contract: ${level}${suit.charAt(0).toUpperCase()}</h3>`;
            displayText += `<p><strong>Score: ${result.score}</strong></p>`;
            displayText += `<div><strong>Breakdown:</strong><ul>`;
            result.details.forEach(detail => {
                displayText += `<li>${detail}</li>`;
            });
            displayText += `</ul></div>`;
            
            let imps = null;
            if (scoringType === 'imps') {
                const opponentScore = parseInt(document.getElementById('opponentScore').value) || 0;
                const scoreDiff = result.score - opponentScore;
                imps = convertToImps(scoreDiff);
                displayText += `<p><strong>Score difference: ${scoreDiff}</strong></p>`;
                displayText += `<p><strong>IMPs: ${imps}</strong></p>`;
            }
            
            document.getElementById('result').innerHTML = displayText;
            document.getElementById('result').style.display = 'block';
            
            // Save score to localStorage
            const scoreData = {
                level,
                suit,
                tricksWon,
                doubled,
                redoubled,
                vulnerable,
                score: result.score,
                scoringType,
                imps,
                timestamp: new Date().toLocaleString()
            };
            
            const scores = loadScores();
            scores.push(scoreData);
            saveScores(scores);
            displayScores();
        });
        
        document.getElementById('clearScores').addEventListener('click', function() {
            if (confirm('Are you sure you want to clear all saved scores?')) {
                saveScores([]);
                displayScores();
                
                // Announce to screen readers
                const announcement = document.createElement('div');
                announcement.setAttribute('aria-live', 'assertive');
                announcement.setAttribute('aria-atomic', 'true');
                announcement.className = 'sr-only';
                announcement.textContent = 'All scores have been cleared';
                document.body.appendChild(announcement);
                
                setTimeout(() => {
                    document.body.removeChild(announcement);
                }, 1000);
            }
        });
        
        // Initialize display on page load
        displayScores();
    </script>
</body>
</html>