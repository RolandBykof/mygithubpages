<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Accessible Chess - Watch Mode Included</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: Arial, sans-serif;
            line-height: 1.2;
            max-width: 600px;
            margin: 0 auto;
            padding: 5px;
            color: #333;
            background-color: #f0f0f0;
            overflow-x: hidden;
        }
        
        h1 { font-size: 1.2rem; margin: 5px 0; text-align: center; }

        #setup-area, #game-area, #moves-container, #help-container {
            background-color: #ffffff; border-radius: 8px; padding: 10px; margin: 5px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #board-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            width: 92vw;
            max-width: 340px;
            aspect-ratio: 1 / 1;
            border: 2px solid #333;
            margin: 5px auto;
            touch-action: manipulation;
        }

        .square {
            aspect-ratio: 1 / 1;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8vw;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        @media (min-width: 400px) { .square { font-size: 32px; } }

        .light { background-color: #f0d9b5; }
        .dark { background-color: #b58863; }
        .selected { outline: 3px solid #3dff3d !important; outline-offset: -3px; }

        .status-box {
            background-color: #e8f4f8; border: 1px solid #b8d8e8; border-radius: 6px;
            padding: 8px; margin-bottom: 5px; font-weight: bold; 
            min-height: 40px; font-size: 0.9rem; text-align: center;
        }

        .button-list { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 5px; 
            list-style: none; 
            padding: 0; 
        }
        .button-list li { flex: 1 1 45%; }
        .button-list li.full-width { flex: 1 1 100%; }

        button {
            background-color: #005fcc; color: white; padding: 10px 5px;
            border: none; border-radius: 6px; font-size: 0.85rem; font-weight: bold;
            width: 100%; cursor: pointer;
        }
        .btn-secondary { background-color: #555; }

        fieldset { border: 1px solid #ccc; padding: 8px; border-radius: 6px; margin-bottom: 8px; font-size: 0.9rem; }
        .hidden { display: none; }

        @media (prefers-color-scheme: dark) {
            body { background-color: #1a1a1a; color: #eee; }
            #setup-area, #game-area, #moves-container, #help-container { background-color: #2a2a2a; }
            .light { background-color: #555; }
            .dark { background-color: #333; }
        }
    </style>
</head>
<body>

    <h1>Chess</h1>

    <div id="setup-area">
        <fieldset>
            <legend>Control & Skill</legend>
            <div style="margin-bottom: 5px;">
                <label><input type="radio" name="inputMethod" value="board" checked> Board</label>
                <label style="margin-left:10px;"><input type="radio" name="inputMethod" value="text"> Text</label>
            </div>
            <select id="skillSelect" style="width:100%; padding:5px;">
                <option value="0">Beginner</option>
                <option value="10">Club</option>
                <option value="20" selected>Pro</option>
            </select>
        </fieldset>

        <ul class="button-list">
            <li><button id="playWhite" onclick="startGame('w')">White</button></li>
            <li><button onclick="startGame('b')">Black</button></li>
            <li class="full-width"><button onclick="startGame('auto')" class="btn-secondary">Watch: CPU vs CPU</button></li>
            <li class="full-width"><button onclick="toggleHelp()" class="btn-secondary">Help</button></li>
        </ul>
    </div>

    <div id="help-container" class="hidden">
        <h2 id="help-title" tabindex="-1" style="font-size:1rem;">Instructions</h2>
        <div id="help-content" style="font-size:0.8rem;"></div>
        <button onclick="toggleHelp()" class="btn-secondary" style="margin-top:10px">Back</button>
    </div>

    <div id="game-area" class="hidden">
        <div id="status" class="status-box" role="alert" aria-live="assertive">Ready.</div>

        <div id="board-container" class="hidden">
            <div id="board-grid" role="grid"></div>
        </div>

        <div id="text-input-container" class="hidden">
            <input id="moveInput" type="text" style="width:100%; padding:10px; margin-bottom:5px;" placeholder="e.g. e4">
            <button onclick="handleTextMove()">Move</button>
        </div>

        <ul class="button-list">
            <li><button onclick="announcePosition()" class="btn-secondary">Scan</button></li>
            <li><button onclick="toggleMoves()" class="btn-secondary">Moves</button></li>
            <li class="full-width"><button onclick="location.reload()" class="btn-secondary">New Game</button></li>
        </ul>

        <div id="moves-container" class="hidden">
            <ul id="moves-list" style="list-style:none; font-size:0.8rem; max-height:80px; overflow-y:auto;"></ul>
        </div>
    </div>

    <script>
        const game = new Chess();
        let engine;
        let selectedSquare = null;
        let controlMethod = "board";
        let mode = 'w';
        let lastMoveText = "";

        const pieceUnicode = {
            'wk': '♔', 'wq': '♕', 'wr': '♖', 'wb': '♗', 'wn': '♘', 'wp': '♙',
            'bk': '♚', 'bq': '♛', 'br': '♜', 'bb': '♝', 'bn': '♞', 'bp': '♟'
        };

        function updateStatus(msg) {
            const s = document.getElementById('status');
            s.innerText = msg;
        }

        function startGame(startMode) {
            mode = startMode;
            controlMethod = document.querySelector('input[name="inputMethod"]:checked').value;
            document.getElementById('setup-area').classList.add('hidden');
            document.getElementById('game-area').classList.remove('hidden');

            if (controlMethod === "board") {
                document.getElementById('board-container').classList.remove('hidden');
                renderBoard();
            } else {
                document.getElementById('text-input-container').classList.remove('hidden');
                document.getElementById('moveInput').focus();
            }

            initEngine(document.getElementById('skillSelect').value);
            
            if (mode === 'auto' || mode === 'b') {
                setTimeout(makeEngineMove, 1000);
            }
            setHelpText();
        }

        function renderBoard() {
            const grid = document.getElementById('board-grid');
            grid.innerHTML = '';
            const board = game.board();

            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    const sq = String.fromCharCode(97 + c) + (8 - r);
                    const p = board[r][c];
                    const btn = document.createElement('button');
                    btn.className = `square ${(r + c) % 2 === 0 ? 'light' : 'dark'}`;
                    if (selectedSquare === sq) btn.classList.add('selected');
                    btn.setAttribute('aria-label', `${sq} ${p ? p.color + ' ' + p.type : 'empty'}`);
                    btn.innerHTML = p ? pieceUnicode[p.color + p.type] : '';
                    btn.onclick = () => { if(mode !== 'auto') handleSquareClick(sq); };
                    grid.appendChild(btn);
                }
            }
        }

        function handleSquareClick(sq) {
            if (!selectedSquare) {
                const p = game.get(sq);
                if (p && p.color === game.turn()) {
                    selectedSquare = sq;
                    renderBoard();
                }
            } else {
                const move = game.move({ from: selectedSquare, to: sq, promotion: 'q' });
                selectedSquare = null;
                if (move) {
                    if (window.navigator.vibrate) window.navigator.vibrate(40);
                    finalizeMove(move);
                    if (!game.game_over()) setTimeout(makeEngineMove, 600);
                }
                renderBoard();
            }
        }

        function handleTextMove() {
            const input = document.getElementById('moveInput');
            const move = game.move(input.value.trim());
            if (move) {
                input.value = '';
                finalizeMove(move);
                if (!game.game_over()) setTimeout(makeEngineMove, 600);
            }
        }

        function initEngine(skill) {
            try {
                const blob = new Blob(["importScripts('https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.js');"], {type: 'application/javascript'});
                engine = new Worker(URL.createObjectURL(blob));
                engine.postMessage('setoption name Skill Level value ' + skill);
            } catch (e) {}
        }

        function makeEngineMove() {
            if (game.game_over()) return;

            // Satunnainen aloitus CPU vs CPU tilassa jos peli on alussa
            if (mode === 'auto' && game.history().length === 0) {
                const openings = ['e4', 'd4', 'Nf3'];
                const move = game.move(openings[Math.floor(Math.random() * openings.length)]);
                finalizeMove(move);
                renderBoard();
                setTimeout(makeEngineMove, 2500);
                return;
            }

            engine.onmessage = (e) => {
                if (e.data.includes('bestmove')) {
                    const move = game.move(e.data.split(' ')[1], { sloppy: true });
                    finalizeMove(move);
                    if (controlMethod === "board") renderBoard();
                    if (mode === 'auto' && !game.game_over()) setTimeout(makeEngineMove, 2500);
                }
            };
            engine.postMessage('position fen ' + game.fen());
            engine.postMessage('go depth 10');
        }

        function finalizeMove(move) {
            lastMoveText = (game.turn() === 'w' ? "Black" : "White") + " " + move.san;
            updateStatus(lastMoveText + (game.in_checkmate() ? " - Checkmate!" : ""));
            updateMovesList();
        }

        function updateMovesList() {
            const list = document.getElementById('moves-list');
            list.innerHTML = '';
            game.history().forEach((m, i) => {
                if (i % 2 === 0) {
                    const li = document.createElement('li');
                    li.textContent = `${(i/2)+1}. ${m} ${game.history()[i+1] || ""}`;
                    list.prepend(li);
                }
            });
        }

        function toggleMoves() { document.getElementById('moves-container').classList.toggle('hidden'); }
        function toggleHelp() { document.getElementById('help-container').classList.toggle('hidden'); }
        function setHelpText() { 
            const text = mode === 'auto' ? "Watching CPU vs CPU. Controls are disabled." : "Select piece then target. Alt+R to repeat.";
            document.getElementById('help-content').innerText = text; 
        }

        function announcePosition() {
            const pieces = [];
            game.board().forEach((row, r) => {
                row.forEach((p, c) => {
                    if (p) pieces.push(`${p.color}${p.type} ${String.fromCharCode(97+c)}${8-r}`);
                });
            });
            updateStatus(pieces.slice(-5).join(", "));
        }
    </script>
</body>
</html>