<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accessible Chess</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <style>
        /* Base styles matching previous versions */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: Arial, Helvetica, sans-serif;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
            padding: 1rem;
            color: #333;
            background-color: #f9f9f9;
        }
        input:focus, button:focus, select:focus, [tabindex="-1"]:focus {
            outline: 3px solid #005fcc; outline-offset: 2px;
        }
        h1 { font-size: 1.8rem; margin-bottom: 1rem; color: #202020; }
        h2 { font-size: 1.4rem; margin-bottom: 0.8rem; color: #303030; }
        
        #setup-area, #game-area, #moves-container, #help-container {
            background-color: #ffffff; border-radius: 10px; padding: 1.5rem; margin: 1rem 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); animation: fadeIn 0.3s ease-in-out;
        }

        .button-list { list-style: none; padding: 0; margin-top: 1rem; display: flex; flex-wrap: wrap; gap: 10px; }
        .button-list li { display: block; }

        .status-box {
            background-color: #e8f4f8; border: 1px solid #b8d8e8; border-radius: 8px;
            padding: 1rem; margin-bottom: 1rem; font-weight: 600;
        }
        
        #moves-list { list-style: none; padding: 0; }
        #moves-list li { padding: 0.5rem 0; border-bottom: 1px solid #eee; }

        input[type="text"], select {
            width: 100%; padding: 0.8rem; margin-bottom: 1rem; border: 1px solid #ccc;
            border-radius: 6px; font-size: 1rem; display: block;
        }

        button {
            background-color: #005fcc; color: #ffffff; padding: 0.8rem 1.2rem;
            border: none; border-radius: 6px; cursor: pointer; font-size: 1rem;
            font-weight: 600; transition: background-color 0.2s;
            min-width: 160px; text-align: center;
        }
        button:hover { background-color: #004799; }
        .btn-secondary { background-color: #6c757d; }
        .btn-secondary:hover { background-color: #5a6268; }
        
        .hidden { display: none; }

        @media (prefers-color-scheme: dark) {
            body { background-color: #121212; color: #e0e0e0; }
            h1, h2 { color: #f0f0f0; }
            #setup-area, #game-area, #moves-container, #help-container { background-color: #1e1e1e; }
            .status-box { background-color: #1a2c35; border-color: #2a4658; color: #e0e0e0; }
            input[type="text"], select { background-color: #2a2a2a; border-color: #444; color: #e0e0e0; }
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <h1>Chess</h1>

    <div id="setup-area">
        <h2>Game Settings</h2>
        <div role="group" aria-labelledby="engine-label">
            <label id="engine-label" for="skillSelect">Opponent Skill Level:</label>
            <select id="skillSelect">
                <option value="0">Beginner</option>
                <option value="10">Intermediate</option>
                <option value="20" selected>Grandmaster (Stockfish Max)</option>
            </select>
        </div>

        <ul class="button-list">
            <li><button id="defaultAction" onclick="startGame('w')">Play as White</button></li>
            <li><button onclick="startGame('b')">Play as Black</button></li>
            <li><button onclick="startGame('auto')" class="btn-secondary">Watch: CPU vs CPU</button></li>
            <li>
                <button onclick="document.getElementById('fileInput').click()" class="btn-secondary">Load Game</button>
                <input type="file" id="fileInput" class="hidden" accept=".pgn" onchange="loadGame(event)">
            </li>
            <li><button id="helpBtnSetup" onclick="toggleHelp('helpBtnSetup')" class="btn-secondary">Help</button></li>
        </ul>
    </div>

    <div id="help-container" class="hidden">
        <h2 id="help-title" tabindex="-1">Instructions</h2>
        <p>This is a fully accessible chess game designed for screen reader users.</p>
        <ul style="margin: 1rem 0 1rem 1.5rem;">
            <li><strong>Moving:</strong> Enter your move using algebraic notation (e.g., <em>e4</em>, <em>Nf3</em>, <em>O-O</em>) and press <strong>Enter</strong>.</li>
            <li><strong>Promotion:</strong> To promote a pawn, add the piece's letter after an equals sign (e.g., <em>a8=Q</em>).</li>
            <li><strong>Hotkeys:</strong> 
                <ul>
                    <li><strong>Alt + R:</strong> Repeat the last move.</li>
                    <li><strong>Alt + P:</strong> Read the positions of all pieces.</li>
                </ul>
            </li>
            <li><strong>Saving/Loading:</strong> You can download your game as a <strong>.pgn</strong> file or upload one to continue a previous session.</li>
        </ul>
        <button id="closeHelpBtn" onclick="toggleHelp()" class="btn-secondary">Close Help</button>
    </div>

    <div id="game-area" class="hidden">
        <div id="status" class="status-box" role="alert" aria-live="assertive">Ready.</div>

        <div id="user-input-section">
            <label for="moveInput">Enter move:</label>
            <input id="moveInput" type="text" autocomplete="off" placeholder="e.g. e4 or a8=Q">
            <button id="sendMoveBtn" onclick="handleUserMove()">Move</button>
        </div>

        <ul class="button-list">
            <li><button onclick="saveGame()" class="btn-secondary">Save Game (PGN)</button></li>
            <li><button onclick="announcePosition()" class="btn-secondary">Read Board</button></li>
            <li><button id="toggleMovesBtn" onclick="toggleMoves()" class="btn-secondary" aria-expanded="false" aria-controls="moves-container">Show Moves</button></li>
            <li><button onclick="location.reload()" class="btn-secondary">New Game</button></li>
        </ul>

        <div id="moves-container" class="hidden">
            <h2>Move List</h2>
            <ul id="moves-list"></ul>
        </div>
    </div>

    <script>
        const game = new Chess();
        let mode = 'w';
        let engine;
        let lastMoveText = "";
        let lastFocusedBtn = null;

        // Hotkeys
        window.addEventListener('keydown', (e) => {
            if (e.altKey) {
                if (e.key.toLowerCase() === 'r') {
                    e.preventDefault();
                    if (lastMoveText) updateStatus(lastMoveText);
                }
                if (e.key.toLowerCase() === 'p') {
                    e.preventDefault();
                    announcePosition();
                }
            }
        });

        // Initialize Stockfish
        try {
            const blob = new Blob([
                "importScripts('https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.js');"
            ], {type: 'application/javascript'});
            engine = new Worker(URL.createObjectURL(blob));
        } catch (e) { console.error("Engine error:", e); }

        function updateStatus(msg) { 
            const status = document.getElementById('status');
            status.innerText = ""; 
            setTimeout(() => { status.innerText = msg; }, 50);
        }

        function startGame(startMode) {
            mode = startMode;
            document.getElementById('setup-area').style.display = 'none';
            document.getElementById('game-area').classList.remove('hidden');
            
            const moveInput = document.getElementById('moveInput');
            moveInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleUserMove(); });
            
            if (mode === 'auto') {
                document.getElementById('user-input-section').classList.add('hidden');
                setTimeout(makeEngineMove, 1000);
            } else {
                moveInput.focus();
                if (mode === 'b') setTimeout(makeEngineMove, 1000);
            }
        }

        // --- NEW: Save and Load Functions ---
        
        function saveGame() {
            const pgn = game.pgn();
            const blob = new Blob([pgn], { type: 'text/plain' });
            const a = document.createElement('a');
            a.download = `chess_game_${new Date().toISOString().slice(0,10)}.pgn`;
            a.href = window.URL.createObjectURL(blob);
            a.click();
            updateStatus("Game saved to file.");
        }

        function loadGame(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                if (game.load_pgn(content)) {
                    updateMovesDisplay();
                    startGame('w'); // Start game area with White by default
                    updateStatus("Game loaded successfully. Your turn.");
                } else {
                    alert("Error: Invalid PGN file.");
                }
            };
            reader.readAsText(file);
        }

        // --- Existing functions ---

        function handleUserMove() {
            const input = document.getElementById('moveInput');
            let val = input.value.trim();
            if (!val) return;
            if (/^[nbrqk]/.test(val)) val = val.charAt(0).toUpperCase() + val.slice(1);
            let move = game.move(val);
            if (move === null && /^[a-h][18]$/.test(val)) move = game.move(val + "=Q");
            if (move === null) { updateStatus("Illegal move: " + val); return; }
            input.value = '';
            finalizeMove(move);
            if (!game.game_over()) setTimeout(makeEngineMove, 600);
            input.focus();
        }

        function makeEngineMove() {
            if (game.game_over()) return;
            if (game.history().length === 0 && mode !== 'w') {
                const move = game.move(['e4', 'd4', 'Nf3', 'c4'][Math.floor(Math.random() * 4)]);
                finalizeMove(move);
                if (mode === 'auto') setTimeout(makeEngineMove, 1500);
                return;
            }
            engine.onmessage = (event) => {
                if (event.data.includes('bestmove')) {
                    const move = game.move(event.data.split(' ')[1], { sloppy: true });
                    finalizeMove(move);
                    if (mode === 'auto' && !game.game_over()) setTimeout(makeEngineMove, 1500);
                }
            };
            engine.postMessage('position fen ' + game.fen());
            engine.postMessage('go depth 12');
        }

        function finalizeMove(move) {
            const turn = game.turn() === 'w' ? "black" : "white";
            updateMovesDisplay();
            lastMoveText = turn + " " + move.san + (game.in_checkmate() ? " - checkmate" : "");
            updateStatus(lastMoveText);
        }

        function updateMovesDisplay() {
            const history = game.history();
            const list = document.getElementById('moves-list');
            list.innerHTML = "";
            for (let i = 0; i < history.length; i += 2) {
                const li = document.createElement('li');
                li.textContent = `${Math.floor(i / 2) + 1}. ${history[i]} ${history[i + 1] || "..."}`;
                list.appendChild(li);
            }
        }

        function toggleHelp(triggerId) {
            const help = document.getElementById('help-container');
            const isOpening = help.classList.contains('hidden');
            if (isOpening) { lastFocusedBtn = triggerId; help.classList.remove('hidden'); document.getElementById('help-title').focus(); }
            else { help.classList.add('hidden'); if (lastFocusedBtn) document.getElementById(lastFocusedBtn).focus(); }
        }

        function toggleMoves() {
            const container = document.getElementById('moves-container');
            container.classList.toggle('hidden');
            document.getElementById('toggleMovesBtn').setAttribute('aria-expanded', !container.classList.contains('hidden'));
        }

        function announcePosition() {
            const board = game.board();
            let p = [];
            const names = {'p':'Pawn','n':'Knight','b':'Bishop','r':'Rook','q':'Queen','k':'King'};
            for (let r=0; r<8; r++) {
                for (let c=0; c<8; c++) {
                    const pc = board[r][c];
                    if (pc) p.push((pc.color==='w'?'White ':'Black ')+names[pc.type]+' '+String.fromCharCode(97+c)+(8-r));
                }
            }
            updateStatus("Position: " + p.join(", "));
        }
    </script>
</body>
</html>