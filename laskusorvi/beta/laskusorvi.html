<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ammattimainen PDF-laskusorvi (EPC QR-koodilla)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <style>
/* Perustyylit */
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

:root {
    --primary-color: #2c3e50;
    --primary-dark: #1a252f;
    --secondary-color: #3498db;
    --accent-color: #e74c3c;
    --accent-hover: #c0392b;
    --background-color: #f8f9fa;
    --container-bg: #ffffff;
    --text-color: #2c3e50;
    --light-text: #7f8c8d;
    --border-color: #dee2e6;
    --table-header-bg: #f8f9fa;
    --table-border: #dee2e6;
    --success-color: #27ae60;
    --success-bg: #d5f4e6;
    --error-color: #e74c3c;
    --error-bg: #fdeaea;
    --border-radius: 8px;
    --shadow: 0 2px 10px rgba(0,0,0,0.1);
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    line-height: 1.6;
    max-width: 1200px;
    margin: 0 auto;
    padding: 1rem;
    color: var(--text-color);
    background-color: var(--background-color);
}

/* Typografia */
h1 {
    font-size: 2rem;
    margin-bottom: 1.5rem;
    color: var(--primary-color);
    text-align: center;
    font-weight: 300;
}

h2 {
    font-size: 1.3rem;
    margin-bottom: 1rem;
    margin-top: 2rem;
    color: var(--primary-color);
    border-bottom: 2px solid var(--secondary-color);
    padding-bottom: 0.5rem;
}

h3 {
    font-size: 1.1rem;
    margin-bottom: 0.8rem;
    color: var(--primary-color);
}

/* Kontainerit */
.container {
    background-color: var(--container-bg);
    padding: 2rem;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    margin-bottom: 2rem;
}

.form-container {
    max-width: 900px;
    margin: 0 auto;
}

/* Lomakkeet */
.form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-bottom: 1.5rem;
}

.form-group {
    margin-bottom: 1rem;
}

label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: var(--primary-color);
    font-size: 0.9rem;
}

input, textarea, select {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid var(--border-color);
    border-radius: var(--border-radius);
    font-size: 1rem;
    font-family: inherit;
    transition: border-color 0.3s ease;
}

input:focus, textarea:focus, select:focus {
    outline: none;
    border-color: var(--secondary-color);
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
}

/* Painikkeet */
button {
    background-color: var(--secondary-color);
    color: white;
    padding: 0.8rem 1.5rem;
    border: none;
    border-radius: var(--border-radius);
    cursor: pointer;
    font-size: 1rem;
    font-weight: 600;
    transition: all 0.3s ease;
    min-height: 44px;
}

button:hover:not([disabled]) {
    background-color: #2980b9;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

button:active {
    transform: translateY(0);
}

.button-primary {
    background-color: var(--primary-color);
}

.button-primary:hover {
    background-color: var(--primary-dark);
}

.button-accent {
    background-color: var(--accent-color);
}

.button-accent:hover {
    background-color: var(--accent-hover);
}

.button-success {
    background-color: var(--success-color);
}

.button-success:hover {
    background-color: #229954;
}

.button-container {
    display: flex;
    justify-content: center;
    gap: 1rem;
    margin-top: 2rem;
    flex-wrap: wrap;
}

/* Ilmoitukset */
.notification {
    padding: 1rem 1.5rem;
    margin: 1rem 0;
    border-radius: var(--border-radius);
    font-weight: 500;
    box-shadow: var(--shadow);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.notification.success {
    background-color: var(--success-bg);
    border-left: 4px solid var(--success-color);
    color: var(--success-color);
}

.notification.error {
    background-color: var(--error-bg);
    border-left: 4px solid var(--error-color);
    color: var(--error-color);
}

.notification.hidden {
    display: none;
}

/* Tietolaatikot */
.info-box {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: 1.5rem;
    margin: 1.5rem 0;
    box-shadow: var(--shadow);
}

.info-box p {
    margin: 0;
    color: var(--light-text);
}

.info-box.important {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    border-color: #f39c12;
}

.info-box.important p {
    color: #856404;
    font-weight: 600;
}

/* Tuotteet */
.product-item {
    background-color: #fafbfc;
    border: 2px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: 1.5rem;
    margin-bottom: 1rem;
    transition: all 0.3s ease;
}

.product-item:hover {
    border-color: var(--secondary-color);
    box-shadow: var(--shadow);
}

#products-container {
    margin-bottom: 1.5rem;
}

/* Valintaruudut */
.checkbox-container {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin: 1rem 0;
    padding: 1rem;
    background-color: var(--table-header-bg);
    border-radius: var(--border-radius);
    border: 1px solid var(--border-color);
}

.checkbox-container input[type="checkbox"] {
    width: 20px;
    height: 20px;
    margin: 0;
}

/* Responsiivinen design */
@media (max-width: 768px) {
    body {
        padding: 0.5rem;
    }
    
    .container {
        padding: 1rem;
    }
    
    h1 {
        font-size: 1.5rem;
    }
    
    .form-row {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .button-container {
        flex-direction: column;
    }
    
    button {
        width: 100%;
        margin: 0.25rem 0;
    }
}

/* Animaatiot */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.container {
    animation: fadeIn 0.5s ease-out;
}

/* Tulostusasetukset */
@media print {
    body {
        background-color: white;
        color: black;
    }
    
    .container {
        box-shadow: none;
        padding: 0;
    }
    
    button, .form-container {
        display: none;
    }
}

/* Dark mode */
@media (prefers-color-scheme: dark) {
    :root {
        --primary-color: #3498db;
        --secondary-color: #2ecc71;
        --background-color: #1a1a1a;
        --container-bg: #2d2d2d;
        --text-color: #ecf0f1;
        --light-text: #bdc3c7;
        --border-color: #4a4a4a;
        --table-header-bg: #3a3a3a;
    }
    
    input, textarea, select {
        background-color: #3a3a3a;
        color: var(--text-color);
        border-color: var(--border-color);
    }
    
    .product-item {
        background-color: #3a3a3a;
    }
}
    </style>
</head>
<body>
    <div class="container">
        <h1>üè¶ Ammattimainen PDF-laskusorvi (EPC QR-koodilla)</h1>
        
        <div id="notification" class="notification hidden" role="alert" aria-live="assertive"></div>

        <div class="info-box important">
            <p>‚ú® <strong>Uusi ominaisuus:</strong> QR-koodi toimii nyt kaikissa suomalaisissa pankkisovelluksissa! K√§ytt√§√§ eurooppalaista EPC/SEPA-standardia.</p>
        </div>

        <div class="form-container">
            <form id="invoice-form">
                
                <h2>Laskun perustiedot</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="invoiceNumber">Laskun numero (3-19 numeroa)</label>
                        <input type="text" id="invoiceNumber" name="invoiceNumber" autocomplete="off" placeholder="esim. 12345">
                        <small style="color: var(--light-text); font-size: 0.85em;">Viitenumero lasketaan automaattisesti</small>
                    </div>
                    <div class="form-group">
                        <label for="invoiceDate">Laskun p√§iv√§m√§√§r√§</label>
                        <input type="date" id="invoiceDate" name="invoiceDate">
                    </div>
                    <div class="form-group">
                        <label for="dueDate">Er√§p√§iv√§</label>
                        <input type="date" id="dueDate" name="dueDate">
                    </div>
                </div>

                <h2>Laskuttajan tiedot</h2>
                <div class="info-box">
                    <p>Laskuttajan tiedot tallennetaan automaattisesti selaimen muistiin ja t√§ytet√§√§n lomakkeeseen, kun avaat sovelluksen seuraavan kerran.</p>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="senderName">Yrityksen nimi</label>
                        <input type="text" id="senderName" name="senderName" autocomplete="organization" placeholder="Yritys Oy">
                    </div>
                    <div class="form-group">
                        <label for="senderYTunnus">Y-tunnus</label>
                        <input type="text" id="senderYTunnus" name="senderYTunnus" placeholder="1234567-8">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="senderAddress">Katuosoite</label>
                        <input type="text" id="senderAddress" name="senderAddress" autocomplete="address-line1" placeholder="Esimerkkikatu 1">
                    </div>
                    <div class="form-group">
                        <label for="senderPostalCode">Postinumero</label>
                        <input type="text" id="senderPostalCode" name="senderPostalCode" autocomplete="postal-code" placeholder="00100">
                    </div>
                    <div class="form-group">
                        <label for="senderCity">Kaupunki</label>
                        <input type="text" id="senderCity" name="senderCity" autocomplete="address-level2" placeholder="Helsinki">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="senderPhone">Puhelinnumero</label>
                        <input type="tel" id="senderPhone" name="senderPhone" autocomplete="tel" placeholder="+358 40 123 4567">
                    </div>
                    <div class="form-group">
                        <label for="senderEmail">S√§hk√∂posti</label>
                        <input type="email" id="senderEmail" name="senderEmail" autocomplete="email" placeholder="info@yritys.fi">
                    </div>
                </div>

                <h2>Asiakkaan tiedot</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="recipientName">Asiakkaan nimi</label>
                        <input type="text" id="recipientName" name="recipientName" placeholder="Matti Meik√§l√§inen">
                    </div>
                    <div class="form-group">
                        <label for="recipientYTunnus">Y-tunnus (jos yritysasiakas)</label>
                        <input type="text" id="recipientYTunnus" name="recipientYTunnus" placeholder="2345678-9">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="recipientAddress">Katuosoite</label>
                        <input type="text" id="recipientAddress" name="recipientAddress" placeholder="Asiakkaankatu 2">
                    </div>
                    <div class="form-group">
                        <label for="recipientPostalCode">Postinumero</label>
                        <input type="text" id="recipientPostalCode" name="recipientPostalCode" placeholder="00200">
                    </div>
                    <div class="form-group">
                        <label for="recipientCity">Kaupunki</label>
                        <input type="text" id="recipientCity" name="recipientCity" placeholder="Espoo">
                    </div>
                </div>

                <h2>Maksutiedot</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="accountNumber">IBAN-tilinumero</label>
                        <input type="text" id="accountNumber" name="accountNumber" placeholder="FI21 1234 5600 0007 85">
                    </div>
                    <div class="form-group">
                        <label for="bic">BIC/SWIFT</label>
                        <input type="text" id="bic" name="bic" placeholder="NDEAFIHH">
                    </div>
                    <div class="form-group">
                        <label for="paymentReference">Viitenumero</label>
                        <input type="text" id="paymentReference" name="paymentReference" readonly style="background-color: #f8f9fa; cursor: not-allowed;">
                        <small style="color: var(--light-text); font-size: 0.85em;">Lasketaan automaattisesti laskun numeron perusteella</small>
                    </div>
                </div>

                <div class="checkbox-container">
                    <input type="checkbox" id="generateBarcode" name="generateBarcode" checked>
                    <label for="generateBarcode">Lis√§√§ EPC QR-koodi ja virtuaaliviivakoodi laskulle (suositeltava - toimii pankkisovelluksissa!)</label>
                </div>

                <h2>Tuotteet ja palvelut</h2>
                <div id="products-container">
                    <!-- Tuotteet lis√§t√§√§n t√§h√§n dynaamisesti -->
                </div>
                
                <button type="button" id="add-product-btn" class="button-accent">Lis√§√§ uusi tuote/palvelu</button>

                <div class="form-row">
                    <div class="form-group">
                        <label for="taxRate">ALV-prosentti</label>
                        <select id="taxRate" name="taxRate">
                            <option value="0">0% (ALV-vapaa)</option>
                            <option value="10">10% (elintarvikkeet, kirjat)</option>
                            <option value="14">14% (ravintola, kulttuuripalvelut)</option>
                            <option value="25.5" selected>25.5% (yleinen ALV)</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="notes">Lis√§tiedot ja huomautukset</label>
                    <textarea id="notes" name="notes" rows="4" placeholder="Esim. Maksumuistutuksesta perit√§√§n 5‚Ç¨ kulut..."></textarea>
                </div>

                <div class="button-container">
                    <button type="button" id="create-pdf" class="button-success">Luo ammattimainen PDF-lasku</button>
                    <button type="button" id="save-sender-data" class="button-primary">Tallenna laskuttajan tiedot</button>
                    <button type="button" id="clear-sender-data" class="button-accent">Tyhjenn√§ tallennetut tiedot</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let productCounter = 0;
        
        const senderFieldIds = [
            'senderName', 'senderYTunnus', 'senderAddress', 'senderPostalCode', 
            'senderCity', 'senderPhone', 'senderEmail', 'accountNumber', 'bic', 'taxRate'
        ];
        
        // Suomalaisen viitenumeron laskenta
        function calculateFinnishReference(base) {
            const cleanBase = base.replace(/\D/g, '');
            if (cleanBase.length < 3 || cleanBase.length > 19) return '';
            
            const multipliers = [7, 3, 1];
            let sum = 0;
            
            for (let i = 0; i < cleanBase.length; i++) {
                const digit = parseInt(cleanBase[cleanBase.length - 1 - i]);
                const multiplier = multipliers[i % 3];
                sum += digit * multiplier;
            }
            
            const nextTen = Math.ceil(sum / 10) * 10;
            let checkDigit = nextTen - sum;
            if (checkDigit === 10) checkDigit = 0;
            
            return cleanBase + checkDigit;
        }
        
        function updateReference() {
            const invoiceNumber = document.getElementById('invoiceNumber').value;
            const referenceField = document.getElementById('paymentReference');
            
            if (invoiceNumber.trim()) {
                const reference = calculateFinnishReference(invoiceNumber);
                if (reference) {
                    // Formatoidaan viitenumero ryhmiin luettavuuden parantamiseksi (vain n√§yt√∂ss√§)
                    const formatted = reference.replace(/(?=(?:\d{5})+(?!\d))(?=\d)/g, ' ');
                    referenceField.value = formatted;
                } else {
                    referenceField.value = '';
                }
            } else {
                referenceField.value = '';
            }
        }
        
        // EPC QR-koodin luonti (SEPA-standardi) - KORJATTU VERSIO
        function createEPCQRData(data) {
            try {
                console.log('Luodaan EPC QR-data...', data);
                
                // EPC QR-koodin rakenne (SEPA-standardi)
                const serviceTag = 'BCD';      // Aina "BCD"
                const version = '002';         // Versio 002 (suositeltava)
                const characterSet = '1';      // UTF-8 encoding
                const identification = 'SCT';  // SEPA Credit Transfer
                
                // BIC-koodi (vapaaehtoinen versiossa 002 ETA-maiden sis√§ll√§)
                const bic = (data.payment.bic || '').trim().substring(0, 11);
                
                // Saajan nimi (maksimissaan 70 merkki√§)
                const beneficiaryName = (data.sender.name || '').trim().substring(0, 70);
                if (!beneficiaryName) {
                    throw new Error('Saajan nimi puuttuu');
                }
                
                // IBAN (maksimissaan 34 merkki√§) - PAKOLLINEN
                let iban = (data.payment.accountNumber || '').replace(/\s+/g, '').toUpperCase();
                if (!iban) {
                    throw new Error('IBAN puuttuu');
                }
                if (!iban.startsWith('FI')) {
                    throw new Error('IBAN pit√§√§ olla suomalainen (FI)');
                }
                iban = iban.substring(0, 34);
                
                // Summa euroina (maksimissaan 999999999.99)
                const amount = Math.min(Math.max(data.total, 0.01), 999999999.99);
                const amountStr = `EUR${amount.toFixed(2)}`;
                
                // Maksun tarkoitus (4 merkki√§, vapaaehtoinen)
                const purpose = ''; // Tyhj√§ = ei m√§√§ritelty
                
                // Strukturoitu viite (RF-viite tai kotimainen viite)
                const structuredReference = (data.payment.reference || '').replace(/\s+/g, '').substring(0, 35);
                
                // Vapaa tekstikentt√§ (maksimissaan 140 merkki√§)
                const unstructuredInfo = data.notes ? data.notes.trim().substring(0, 140) : '';
                
                // Koosta EPC-data (elementit erotettu \n-merkill√§)
                // HUOM: Tyhj√§t kent√§t pit√§√§ sis√§llytt√§√§!
                const epcData = [
                    serviceTag,           // BCD
                    version,              // 002
                    characterSet,         // 1
                    identification,       // SCT
                    bic,                  // BIC (voi olla tyhj√§)
                    beneficiaryName,      // Saajan nimi
                    iban,                 // IBAN
                    amountStr,            // EUR123.45
                    purpose,              // Tyhj√§
                    structuredReference,  // Viitenumero
                    unstructuredInfo      // Lis√§tiedot
                ].join('\n');
                
                console.log('EPC QR-data luotu:', {
                    serviceTag,
                    version,
                    characterSet,
                    identification,
                    bic,
                    beneficiaryName,
                    iban,
                    amountStr,
                    purpose,
                    structuredReference,
                    unstructuredInfo,
                    fullData: epcData.replace(/\n/g, '\\n')
                });
                
                return epcData;
                
            } catch (err) {
                console.error('Virhe EPC QR-koodin luonnissa:', err.message);
                return null;
            }
        }
        
        // QR-koodin generointi - KORJATTU VERSIO
        function generateQRCode(text) {
            try {
                if (!text || text.trim() === '') {
                    throw new Error('QR-koodin sis√§lt√∂ on tyhj√§');
                }
                
                console.log('Generoidaan QR-koodi tekstille:', text);
                
                // Kokeile eri QR-koodin versioita
                for (let typeNumber = 4; typeNumber <= 10; typeNumber++) {
                    try {
                        const qr = qrcode(typeNumber, 'M'); // M = Medium error correction
                        qr.addData(text);
                        qr.make();
                        
                        const dataUrl = qr.createDataURL(4); // 4px moduuli
                        console.log(`QR-koodi luotu onnistuneesti (versio ${typeNumber})`);
                        return dataUrl;
                    } catch (versionError) {
                        console.warn(`QR versio ${typeNumber} ep√§onnistui:`, versionError.message);
                        continue;
                    }
                }
                
                throw new Error('Kaikki QR-koodin versiot ep√§onnistuivat');
                
            } catch (err) {
                console.error('QR-koodin generointi ep√§onnistui:', err.message);
                return null;
            }
        }
        
        // Virtuaaliviivakoodin luonti (s√§ilytet√§√§n tekstin√§ laskulla)
        function createVirtualBarcode(data) {
            try {
                const version = '4';
                
                let iban = (data.payment.accountNumber || '').replace(/\s+/g, '');
                if (iban.toUpperCase().startsWith('FI')) {
                    iban = iban.slice(2);
                }
                iban = iban.padStart(16, '0').substring(0, 16);
                
                const amountCents = Math.round(data.total * 100);
                const euros = Math.floor(amountCents / 100);
                const cents = amountCents % 100;
                const eurosStr = euros.toString().padStart(6, '0');
                const centsStr = cents.toString().padStart(2, '0');
                
                const reserved = '000';
                
                let reference = (data.payment.reference || '').replace(/\s+/g, '');
                reference = reference.padStart(20, '0').substring(0, 20);
                
                let dueDateStr = '000000';
                const dueDate = new Date(data.dueDate);
                if (!isNaN(dueDate.getTime())) {
                    const yy = dueDate.getFullYear().toString().slice(-2);
                    const mm = (dueDate.getMonth() + 1).toString().padStart(2, '0');
                    const dd = dueDate.getDate().toString().padStart(2, '0');
                    dueDateStr = yy + mm + dd;
                }
                
                const barcode = version + iban + eurosStr + centsStr + reserved + reference + dueDateStr;
                
                if (barcode.length !== 54) {
                    throw new Error(`Viivakoodin pituus ${barcode.length}, odotettu 54`);
                }
                
                return barcode;
            } catch (err) {
                console.error('Virhe viivakoodin luonnissa:', err);
                return '';
            }
        }
        
        // Lomakkeen alustus
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Alustetaan ammattimainen laskusorvi (EPC QR-koodilla)");
            
            const today = new Date();
            document.getElementById('invoiceDate').valueAsDate = today;
            
            const dueDate = new Date(today);
            dueDate.setDate(today.getDate() + 14);
            document.getElementById('dueDate').valueAsDate = dueDate;
            
            loadSenderData();
            addProductRow();
            document.getElementById('invoiceNumber').focus();
            
            // Event listenerit
            document.getElementById('add-product-btn').addEventListener('click', addProductRow);
            document.getElementById('create-pdf').addEventListener('click', createPDF);
            document.getElementById('invoiceNumber').addEventListener('input', updateReference);
            
            document.getElementById('save-sender-data').addEventListener('click', function() {
                saveSenderData();
                showNotification('Laskuttajan tiedot tallennettu onnistuneesti!', 'success');
            });
            
            document.getElementById('clear-sender-data').addEventListener('click', clearSenderData);
        });
        
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.remove('hidden');
            
            setTimeout(function() {
                notification.classList.add('hidden');
            }, 4000);
        }
        
        function saveSenderData() {
            senderFieldIds.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field && field.value) {
                    // Tallennetaan in-memory muistiin (ei localStorage artifakteissa)
                    window.invoiceAppData = window.invoiceAppData || {};
                    window.invoiceAppData[fieldId] = field.value;
                }
            });
        }
        
        function loadSenderData() {
            let dataFound = false;
            
            senderFieldIds.forEach(fieldId => {
                const savedValue = window.invoiceAppData && window.invoiceAppData[fieldId];
                const field = document.getElementById(fieldId);
                
                if (savedValue && field) {
                    field.value = savedValue;
                    dataFound = true;
                }
            });
            
            if (dataFound) {
                showNotification('Tallennetut laskuttajan tiedot ladattu!', 'success');
            }
        }
        
        function clearSenderData() {
            senderFieldIds.forEach(fieldId => {
                if (window.invoiceAppData) {
                    delete window.invoiceAppData[fieldId];
                }
                const field = document.getElementById(fieldId);
                if (field) field.value = '';
            });
            
            showNotification('Tallennetut tiedot tyhjennetty.', 'error');
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('fi-FI');
        }
        
        function formatNumber(number) {
            return Number(number).toFixed(2).replace('.', ',');
        }
        
        function addProductRow() {
            const productsContainer = document.getElementById('products-container');
            
            const productItem = document.createElement('div');
            productItem.className = 'product-item';
            productItem.id = `product-${productCounter}`;
            
            productItem.innerHTML = `
                <div class="form-row">
                    <div class="form-group">
                        <label for="productDescription${productCounter}">Tuotteen/palvelun kuvaus</label>
                        <input type="text" id="productDescription${productCounter}" name="productDescription${productCounter}" placeholder="esim. Verkkosivujen suunnittelu">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="productQuantity${productCounter}">M√§√§r√§</label>
                        <input type="number" id="productQuantity${productCounter}" name="productQuantity${productCounter}" value="1" min="1" step="1">
                    </div>
                    <div class="form-group">
                        <label for="productUnit${productCounter}">Yksikk√∂</label>
                        <input type="text" id="productUnit${productCounter}" name="productUnit${productCounter}" value="kpl" placeholder="kpl/h/kg">
                    </div>
                    <div class="form-group">
                        <label for="productPrice${productCounter}">Yksikk√∂hinta (‚Ç¨, ALV 0%)</label>
                        <input type="number" id="productPrice${productCounter}" name="productPrice${productCounter}" min="0" step="0.01" placeholder="100.00">
                    </div>
                </div>
            `;
            
            if (productCounter > 0) {
                const removeButton = document.createElement('button');
                removeButton.type = 'button';
                removeButton.className = 'button-accent';
                removeButton.style.marginTop = '1rem';
                removeButton.textContent = 'Poista t√§m√§ tuote';
                removeButton.dataset.id = `product-${productCounter}`;
                
                removeButton.addEventListener('click', function() {
                    const productId = this.dataset.id;
                    const productToRemove = document.getElementById(productId);
                    if (productToRemove) {
                        productsContainer.removeChild(productToRemove);
                        showNotification('Tuote poistettu', 'error');
                    }
                });
                
                productItem.appendChild(removeButton);
            }
            
            productsContainer.appendChild(productItem);
            document.getElementById(`productDescription${productCounter}`).focus();
            productCounter++;
        }
        
        function collectFormData() {
            const formData = {
                invoiceNumber: document.getElementById('invoiceNumber').value,
                invoiceDate: document.getElementById('invoiceDate').value,
                dueDate: document.getElementById('dueDate').value,
                sender: {
                    name: document.getElementById('senderName').value,
                    ytunnus: document.getElementById('senderYTunnus').value,
                    address: document.getElementById('senderAddress').value,
                    postalCode: document.getElementById('senderPostalCode').value,
                    city: document.getElementById('senderCity').value,
                    phone: document.getElementById('senderPhone').value,
                    email: document.getElementById('senderEmail').value
                },
                recipient: {
                    name: document.getElementById('recipientName').value,
                    ytunnus: document.getElementById('recipientYTunnus').value,
                    address: document.getElementById('recipientAddress').value,
                    postalCode: document.getElementById('recipientPostalCode').value,
                    city: document.getElementById('recipientCity').value
                },
                payment: {
                    accountNumber: document.getElementById('accountNumber').value,
                    bic: document.getElementById('bic').value,
                    reference: document.getElementById('paymentReference').value.replace(/\s+/g, '')
                },
                products: [],
                taxRate: parseFloat(document.getElementById('taxRate').value),
                notes: document.getElementById('notes').value,
                generateBarcode: document.getElementById('generateBarcode').checked
            };
            
            // Ker√§√§ tuotteet
            const productItems = document.querySelectorAll('.product-item');
            productItems.forEach((item) => {
                const idNum = item.id.split('-')[1];
                const description = document.getElementById(`productDescription${idNum}`)?.value || '';
                const quantity = parseFloat(document.getElementById(`productQuantity${idNum}`)?.value || '1');
                const unit = document.getElementById(`productUnit${idNum}`)?.value || 'kpl';
                const price = parseFloat(document.getElementById(`productPrice${idNum}`)?.value || '0');
                
                if (description.trim()) {
                    const total = quantity * price;
                    formData.products.push({ description, quantity, unit, price, total });
                }
            });
            
            // Laske summat
            let subtotal = 0;
            formData.products.forEach(product => {
                subtotal += product.total;
            });
            
            const taxAmount = subtotal * (formData.taxRate / 100);
            const total = subtotal + taxAmount;
            
            formData.subtotal = subtotal;
            formData.taxAmount = taxAmount;
            formData.total = total;
            
            return formData;
        }
        
        // Parannettu PDF-luonti EPC QR-koodilla - KORJATTU VERSIO
        function createPDF() {
            saveSenderData();
            const data = collectFormData();
            
            console.log('Luodaan PDF seuraavilla tiedoilla:', data);
            
            // Validointi
            if (!data.invoiceNumber) {
                showNotification('Laskun numero puuttuu!', 'error');
                return;
            }
            if (!data.sender.name) {
                showNotification('Laskuttajan nimi puuttuu!', 'error');
                return;
            }
            if (!data.recipient.name) {
                showNotification('Asiakkaan nimi puuttuu!', 'error');
                return;
            }
            if (data.products.length === 0) {
                showNotification('Lis√§√§ v√§hint√§√§n yksi tuote!', 'error');
                return;
            }
            if (!data.payment.accountNumber) {
                showNotification('IBAN-tilinumero puuttuu!', 'error');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });
            
            // PDF metatiedot
            doc.setProperties({
                title: `Lasku ${data.invoiceNumber}`,
                subject: `Lasku ${data.sender.name} - ${data.recipient.name}`,
                creator: 'Ammattimainen PDF-laskusorvi (EPC QR)',
                author: data.sender.name || 'Laskuttaja'
            });
            
            // Luo PDF layout
            createImprovedLayout(doc, data);
        }
        
        function createImprovedLayout(doc, data) {
            const margin = 20;
            const lineHeight = 6;
            const pageWidth = 210;
            const pageHeight = 297;
            
            let y = margin;
            
            // --- HEADER ---
            doc.setFont("helvetica", "bold");
            doc.setFontSize(24);
            doc.text('LASKU', pageWidth / 2, y, { align: 'center' });
            
            doc.setFontSize(10);
            doc.text(`Sivu 1/1`, pageWidth - margin, y, { align: 'right' });
            
            y += 15;
            
            // --- LASKUTTAJAN TIEDOT VASEMMALLA ---
            doc.setFont("helvetica", "bold");
            doc.setFontSize(12);
            if (data.sender.name) {
                doc.text(data.sender.name, margin, y);
                y += lineHeight;
            }
            
            doc.setFont("helvetica", "normal");
            doc.setFontSize(10);
            
            if (data.sender.address) {
                doc.text(data.sender.address, margin, y);
                y += lineHeight;
            }
            if (data.sender.postalCode || data.sender.city) {
                doc.text(`${data.sender.postalCode || ''} ${data.sender.city || ''}`, margin, y);
                y += lineHeight;
            }
            
            // --- LASKUN TIEDOT OIKEALLA ---
            const rightColX = 120;
            let rightY = margin + 15;
            
            // Taulukon header
            doc.setFillColor(248, 249, 250);
            doc.rect(rightColX, rightY, 70, lineHeight * 8, 'F');
            doc.setDrawColor(200, 200, 200);
            doc.rect(rightColX, rightY, 70, lineHeight * 8, 'S');
            
            // Taulukon tiedot
            const infoRows = [
                ['Asiakas', data.recipient.name || ''],
                ['Lasku No.', data.invoiceNumber || ''],
                ['Laskun pvm', formatDate(data.invoiceDate)],
                ['Er√§p√§iv√§', formatDate(data.dueDate)],
                ['Viitenumero', data.payment.reference || ''],
                ['ALV-%', data.taxRate + '%'],
                ['Summa EUR', formatNumber(data.total)]
            ];
            
            doc.setFont("helvetica", "normal");
            doc.setFontSize(9);
            
            infoRows.forEach((row, index) => {
                const rowY = rightY + 5 + (index * lineHeight);
                doc.setFont("helvetica", "bold");
                doc.text(row[0], rightColX + 2, rowY);
                doc.setFont("helvetica", "normal");
                doc.text(row[1], rightColX + 25, rowY);
            });
            
            y = rightY + (lineHeight * 9);
            
            // --- ASIAKKAAN TIEDOT ---
            y += 10;
            doc.setFont("helvetica", "bold");
            doc.setFontSize(12);
            doc.text('Laskutettava', margin, y);
            
            doc.setFont("helvetica", "normal");
            doc.setFontSize(10);
            y += lineHeight;
            
            if (data.recipient.name) {
                doc.text(data.recipient.name, margin, y);
                y += lineHeight;
            }
            if (data.recipient.ytunnus) {
                doc.text(`Y-tunnus: ${data.recipient.ytunnus}`, margin, y);
                y += lineHeight;
            }
            if (data.recipient.address) {
                doc.text(data.recipient.address, margin, y);
                y += lineHeight;
            }
            if (data.recipient.postalCode || data.recipient.city) {
                doc.text(`${data.recipient.postalCode || ''} ${data.recipient.city || ''}`, margin, y);
                y += lineHeight;
            }
            
            // --- TUOTETAULUKKO ---
            y += 15;
            
            doc.setFont("helvetica", "bold");
            doc.setFontSize(12);
            doc.text('Tuotteet / Palvelut', margin, y);
            y += 8;
            
            // Taulukon otsikot
            const colWidths = [80, 15, 20, 25, 30];
            const headers = ['Nimike', 'M√§√§r√§', 'Yksikk√∂', 'A-Hinta', 'Yhteens√§'];
            
            // Otsikkorivi tausta
            doc.setFillColor(248, 249, 250);
            doc.rect(margin, y - 4, colWidths.reduce((a, b) => a + b, 0), lineHeight, 'F');
            doc.setDrawColor(200, 200, 200);
            doc.rect(margin, y - 4, colWidths.reduce((a, b) => a + b, 0), lineHeight, 'S');
            
            doc.setFont("helvetica", "bold");
            doc.setFontSize(9);
            
            let xPos = margin;
            headers.forEach((header, i) => {
                doc.text(header, xPos + 2, y);
                xPos += colWidths[i];
            });
            
            y += lineHeight;
            
            // Tuoterivit
            doc.setFont("helvetica", "normal");
            data.products.forEach(product => {
                xPos = margin;
                
                // Rivien reunat
                doc.setDrawColor(230, 230, 230);
                doc.rect(margin, y - 4, colWidths.reduce((a, b) => a + b, 0), lineHeight, 'S');
                
                doc.text(product.description, xPos + 2, y);
                xPos += colWidths[0];
                
                doc.text(String(product.quantity), xPos + 2, y);
                xPos += colWidths[1];
                
                doc.text(product.unit, xPos + 2, y);
                xPos += colWidths[2];
                
                doc.text(formatNumber(product.price), xPos + 2, y);
                xPos += colWidths[3];
                
                doc.text(formatNumber(product.total), xPos + 2, y);
                
                y += lineHeight;
            });
            
            // --- YHTEENVETO ---
            y += 10;
            
            const summaryRows = [
                ['Verokanta', 'Veroton summa', 'Veron osuus', 'Verollinen summa'],
                [`${data.taxRate} %`, formatNumber(data.subtotal), formatNumber(data.taxAmount), formatNumber(data.total)],
                ['', formatNumber(data.subtotal), formatNumber(data.taxAmount), formatNumber(data.total)]
            ];
            
            summaryRows.forEach((row, index) => {
                if (index === 0) {
                    // Otsikkorivi
                    doc.setFillColor(248, 249, 250);
                    doc.rect(margin + 80, y - 3, 90, lineHeight, 'F');
                    doc.setFont("helvetica", "bold");
                } else if (index === 2) {
                    // Loppusumma
                    doc.setFont("helvetica", "bold");
                } else {
                    doc.setFont("helvetica", "normal");
                }
                
                doc.setDrawColor(200, 200, 200);
                doc.rect(margin + 80, y - 3, 90, lineHeight, 'S');
                
                let summaryX = margin + 82;
                const summaryColWidth = 22;
                
                row.forEach(cell => {
                    doc.text(cell, summaryX, y);
                    summaryX += summaryColWidth;
                });
                
                y += lineHeight;
            });
            
            // --- MAKSUTIEDOT ---
            y += 15;
            
            // Tilisiirto-laatikko
            const transferBoxHeight = 40;
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(0.5);
            doc.rect(margin, y, pageWidth - (margin * 2), transferBoxHeight, 'S');
            
            // "TILISIIRTO" -otsikko
            doc.setFont("helvetica", "bold");
            doc.setFontSize(10);
            doc.text('TILISIIRTO', margin + 5, y + 8);
            
            // Maksutiedot
            doc.setFont("helvetica", "normal");
            doc.setFontSize(9);
            
            const paymentInfoY = y + 15;
            doc.text('Saajan tilinumero', margin + 5, paymentInfoY);
            doc.text('IBAN', margin + 5, paymentInfoY + 5);
            doc.text(data.payment.accountNumber || '', margin + 5, paymentInfoY + 10);
            
            doc.text('BIC', margin + 60, paymentInfoY);
            doc.text(data.payment.bic || '', margin + 60, paymentInfoY + 5);
            
            doc.text('Saaja', margin + 5, paymentInfoY + 18);
            doc.text(data.sender.name || '', margin + 5, paymentInfoY + 23);
            
            // Maksajan tiedot oikealla
            doc.text('Maksajan nimi ja osoite', margin + 100, paymentInfoY);
            doc.text(data.recipient.name || '', margin + 100, paymentInfoY + 5);
            if (data.recipient.address) {
                doc.text(data.recipient.address, margin + 100, paymentInfoY + 10);
            }
            if (data.recipient.postalCode || data.recipient.city) {
                doc.text(`${data.recipient.postalCode || ''} ${data.recipient.city || ''}`, margin + 100, paymentInfoY + 15);
            }
            
            // Viitenumero ja summa
            doc.text('Viitenumero', margin + 5, paymentInfoY + 30);
            doc.text(data.payment.reference || '', margin + 30, paymentInfoY + 30);
            
            doc.text('EUR', pageWidth - margin - 20, paymentInfoY + 25);
            doc.setFont("helvetica", "bold");
            doc.setFontSize(12);
            doc.text(formatNumber(data.total), pageWidth - margin - 5, paymentInfoY + 30, { align: 'right' });
            
            y += transferBoxHeight + 10;
            
            // --- QR-KOODI JA VIRTUAALIVIIVAKOODI ---
            if (data.generateBarcode) {
                // Virtuaaliviivakoodi (s√§ilytet√§√§n tekstin√§)
                const barcode = createVirtualBarcode(data);
                if (barcode) {
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(11);
                    doc.text('Virtuaaliviivakoodi', margin, y);
                    
                    y += 8;
                    doc.setFont("courier", "normal");
                    doc.setFontSize(10);
                    doc.text(barcode, margin, y);
                    
                    y += 10;
                }
                
                // EPC QR-koodi - KORJATTU VERSIO
                doc.setFont("helvetica", "bold");
                doc.setFontSize(11);
                doc.text('EPC QR-koodi (pankkisovelluksille)', margin, y);
                
                // Luo EPC QR-data
                const epcData = createEPCQRData(data);
                if (epcData) {
                    console.log('EPC-data luotu, generoidaan QR-koodi...');
                    
                    // Generoi QR-koodi
                    const qrDataUrl = generateQRCode(epcData);
                    if (qrDataUrl) {
                        console.log('QR-koodi luotu onnistuneesti, lis√§t√§√§n PDF:√§√§n...');
                        
                        try {
                            // Lis√§√§ QR-koodi PDF:√§√§n
                            doc.addImage(qrDataUrl, 'PNG', pageWidth - margin - 30, y - 5, 25, 25);
                            
                            // Lis√§√§ ohjeteksti
                            doc.setFont("helvetica", "normal");
                            doc.setFontSize(8);
                            const instructionText = 'Skannaa QR-koodi\npankkisovelluksellasi';
                            const splitText = instructionText.split('\n');
                            splitText.forEach((line, index) => {
                                doc.text(line, pageWidth - margin - 17.5, y + 25 + (index * 3), { align: 'center' });
                            });
                            
                            console.log('QR-koodi lis√§tty PDF:√§√§n onnistuneesti');
                        } catch (imageError) {
                            console.error('Virhe QR-koodin lis√§√§misess√§ PDF:√§√§n:', imageError);
                            showNotification('QR-koodin lis√§√§minen ep√§onnistui, mutta PDF luotiin', 'error');
                        }
                    } else {
                        console.error('QR-koodin generointi ep√§onnistui');
                        showNotification('QR-koodin luonti ep√§onnistui, mutta PDF luotiin', 'error');
                    }
                } else {
                    console.error('EPC-datan luonti ep√§onnistui');
                    showNotification('EPC-datan luonti ep√§onnistui, mutta PDF luotiin', 'error');
                }
            }
            
            // Lis√§tiedot
            if (data.notes) {
                const notesY = y + 35;
                doc.setFont("helvetica", "bold");
                doc.setFontSize(10);
                doc.text('Lis√§tiedot:', margin, notesY);
                
                doc.setFont("helvetica", "normal");
                doc.setFontSize(9);
                const splitNotes = doc.splitTextToSize(data.notes, pageWidth - (margin * 2) - 35);
                doc.text(splitNotes, margin, notesY + 6);
            }
            
            // Tallenna PDF
            const filename = `lasku_${data.invoiceNumber}.pdf`;
            
            try {
                doc.save(filename);
                console.log('PDF tallennettu onnistuneesti:', filename);
                showNotification(`PDF-lasku "${filename}" luotu onnistuneesti! ${data.generateBarcode ? 'QR-koodi toimii pankkisovelluksissa.' : ''}`, 'success');
            } catch (saveError) {
                console.error('PDF:n tallentaminen ep√§onnistui:', saveError);
                showNotification('PDF:n tallentaminen ep√§onnistui!', 'error');
            }
        }
    </script>
</body>
</html>